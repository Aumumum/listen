/**
 * vscroll (UMD)  by Denis Hilt | https://github.com/dhilt/vscroll | 2021-07-14T23:49:16.874Z | MIT license
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("vscroll",["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).VScroll={})}(this,(function(e){"use strict";var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,i)};function i(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}var n=function(){return(n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function r(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function o(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var n,r,o=i.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)s.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}return s}function s(e,t){for(var i=0,n=t.length,r=e.length;i<n;i++,r++)e[r]=t[i];return e}var a,l,u=function(){function e(e,t){this.id=0,void 0!==e&&(this.value=e,this.initialValue=e),this.options=t||{},this.subscriptions=new Map}return e.prototype.set=function(e){var t,i;if(this.value!==e||this.options.emitEqual){this.value=e;try{for(var n=r(this.subscriptions),s=n.next();!s.done;s=n.next()){if(o(s.value,2)[1].emit(e),this.value!==e)break}}catch(e){t={error:e}}finally{try{s&&!s.done&&(i=n.return)&&i.call(n)}finally{if(t)throw t.error}}}},e.prototype.get=function(){return this.value},e.prototype.on=function(e){var t=this,i=this.id++,n={emit:e,off:function(){n.emit=function(){return null},t.subscriptions.delete(i)}};return this.subscriptions.set(i,n),this.options.emitOnSubscribe&&n.emit(this.value),function(){return n.off()}},e.prototype.once=function(e){var t=this.on((function(i){t(),e(i)}));return t},e.prototype.reset=function(){this.set(this.initialValue)},e.prototype.dispose=function(){this.subscriptions.forEach((function(e){return e.off()}))},e}();e.AdapterPropName=void 0,(a=e.AdapterPropName||(e.AdapterPropName={})).id="id",a.mock="mock",a.augmented="augmented",a.version="version",a.init="init",a.init$="init$",a.packageInfo="packageInfo",a.itemsCount="itemsCount",a.bufferInfo="bufferInfo",a.isLoading="isLoading",a.isLoading$="isLoading$",a.loopPending="loopPending",a.loopPending$="loopPending$",a.firstVisible="firstVisible",a.firstVisible$="firstVisible$",a.lastVisible="lastVisible",a.lastVisible$="lastVisible$",a.bof="bof",a.bof$="bof$",a.eof="eof",a.eof$="eof$",a.reset="reset",a.reload="reload",a.append="append",a.prepend="prepend",a.check="check",a.remove="remove",a.clip="clip",a.insert="insert",a.replace="replace",a.update="update",a.fix="fix",a.relax="relax",a.showLog="showLog",function(e){e[e.Scalar=0]="Scalar",e[e.Reactive=1]="Reactive",e[e.WorkflowRunner=2]="WorkflowRunner",e[e.Function=3]="Function"}(l||(l={}));var c,f,d,p=e.AdapterPropName,h=l,g=function(){return null},m={immediate:!0,success:!0,details:"Adapter is not initialized"},v=function(){return Promise.resolve(m)},x={core:{name:"",version:""},consumer:{name:"",version:""}},b={firstIndex:NaN,lastIndex:NaN,minIndex:NaN,maxIndex:NaN,absMinIndex:-1/0,absMaxIndex:1/0,defaultSize:NaN},y={data:{},element:{}},I=function(){return[{type:h.Scalar,name:p.id,value:0,permanent:!0},{type:h.Scalar,name:p.mock,value:!0,permanent:!0},{type:h.Scalar,name:p.augmented,value:!1,permanent:!0},{type:h.Scalar,name:p.version,value:"",permanent:!0},{type:h.Scalar,name:p.init,value:!1,reactive:p.init$},{type:h.Scalar,name:p.packageInfo,value:x,onDemand:!0},{type:h.Scalar,name:p.itemsCount,value:0,onDemand:!0},{type:h.Scalar,name:p.bufferInfo,value:b,onDemand:!0},{type:h.Scalar,name:p.isLoading,value:!1,reactive:p.isLoading$},{type:h.Scalar,name:p.loopPending,value:!1,reactive:p.loopPending$},{type:h.Scalar,name:p.firstVisible,value:y,reactive:p.firstVisible$,wanted:!0},{type:h.Scalar,name:p.lastVisible,value:y,reactive:p.lastVisible$,wanted:!0},{type:h.Scalar,name:p.bof,value:!1,reactive:p.bof$},{type:h.Scalar,name:p.eof,value:!1,reactive:p.eof$},{type:h.WorkflowRunner,name:p.reset,value:v},{type:h.WorkflowRunner,name:p.reload,value:v},{type:h.WorkflowRunner,name:p.append,value:v},{type:h.WorkflowRunner,name:p.prepend,value:v},{type:h.WorkflowRunner,name:p.check,value:v},{type:h.WorkflowRunner,name:p.remove,value:v},{type:h.WorkflowRunner,name:p.clip,value:v},{type:h.WorkflowRunner,name:p.insert,value:v},{type:h.WorkflowRunner,name:p.replace,value:v},{type:h.WorkflowRunner,name:p.update,value:v},{type:h.WorkflowRunner,name:p.fix,value:v},{type:h.Function,name:p.relax,value:g},{type:h.Function,name:p.showLog,value:g},{type:h.Reactive,name:p.init$,value:new u},{type:h.Reactive,name:p.isLoading$,value:new u},{type:h.Reactive,name:p.loopPending$,value:new u},{type:h.Reactive,name:p.firstVisible$,value:new u(y,{emitOnSubscribe:!0})},{type:h.Reactive,name:p.lastVisible$,value:new u(y,{emitOnSubscribe:!0})},{type:h.Reactive,name:p.bof$,value:new u},{type:h.Reactive,name:p.eof$,value:new u}]},w=new Map,S={name:"vscroll",version:"1.2.0"},z=0,k=function(t){var i=this,r=t.mock,o=t.reactive,s=++z,a={configurable:!0},u={};Object.defineProperty(this,e.AdapterPropName.id,n({get:function(){return s}},a)),Object.defineProperty(this,e.AdapterPropName.mock,n({get:function(){return r}},a)),Object.defineProperty(this,e.AdapterPropName.augmented,n({get:function(){return!1}},a)),Object.defineProperty(this,e.AdapterPropName.version,n({get:function(){return S.version}},a)),I().filter((function(e){return!e.permanent})).forEach((function(e){var t=e.name,r=e.value,s=e.type;if(o&&s===l.Reactive){var c=o[t];c&&(u[t]=n(n({},c),{default:r}),r=c.source)}Object.defineProperty(i,t,n({get:function(){return r}},a))})),o&&w.set(s,u)},N=function(){function e(e,t){this.get=e.get,e.settings&&(this.settings=e.settings),e.devSettings&&(this.devSettings=e.devSettings);var i=new k(t||{mock:!1});this.adapter=i}return e.prototype.dispose=function(){w.delete(this.adapter.id)},e}(),E=function(e){return function(t){function n(i){var n="function"==typeof e?e():void 0;return t.call(this,i,n)||this}return i(n,t),n}(N)},O=E();e.Direction=void 0,(c=e.Direction||(e.Direction={})).forward="forward",c.backward="backward",e.SizeStrategy=void 0,(f=e.SizeStrategy||(e.SizeStrategy={})).Average="average",f.Constant="constant",f.Frequent="frequent",function(e){e.number="must be a number",e.integer="must be an integer",e.integerUnlimited="must be an integer or infinity",e.moreOrEqual="must be a number greater than (or equal to) {arg1}",e.itemList="must be an array of items {arg1}",e.boolean="must be a boolean",e.object="must be an object",e.element="must be an html element",e.function="must be a function",e.funcOfxArguments="must have {arg1} argument(s)",e.funcOfxAndMoreArguments="must have at least {arg1} argument(s)",e.funcOfXToYArguments="must have {arg1} to {arg2} arguments",e.oneOfCan="can be present as only one item of {arg1} list",e.oneOfMust="must be present as only one item of {arg1} list",e.or="must satisfy at least 1 validator from {arg1} list",e.enum="must belong to {arg1} list"}(d||(d={}));var M,V,P=function(e,t){return(t||[""]).reduce((function(e,t,i){return e.replace("{arg"+(i+1)+"}",t)}),e)},A=function(e){return"number"==typeof e||"string"==typeof e&&""!==e?Number(e):NaN},D=function(e){var t=A(e),i=[];return Number.isNaN(t)&&i.push(d.number),{value:t,isSet:!0,isValid:!i.length,errors:i}},$=function(e,t){return function(i){var n=D(i);if(!n.isValid)return n;var r=n.value,o=[];return r<e&&(t?r=e:o.push(P(d.moreOrEqual,[String(e)]))),{value:r,isSet:!0,isValid:!o.length,errors:o}}},T=function(e){var t=[];return"function"!=typeof e&&t.push(d.function),{value:e,isSet:!0,isValid:!t.length,errors:t}},R=function(e,t){return function(i){var n=T(i);if(!n.isValid)return n;var r=[];return((i=n.value).length<e||i.length>t)&&r.push(P(d.funcOfXToYArguments,[String(e),String(t)])),{value:i,isSet:!0,isValid:!r.length,errors:r}}},j=function(e,t){return function(i,n){var r=[],o=void 0!==i,s=!o,a=t?d.oneOfMust:d.oneOfCan;if(Array.isArray(e)&&e.length){for(var l=e.length-1;l>=0;l--){var u=e[l];if("string"!=typeof u){r.push(P(a,[e.join('", "')])+" (non-string token)");break}var c=n&&Object.prototype.hasOwnProperty.call(n,u);if(o&&c){r.push(P(a,[e.join('", "')])+" ("+u+" is present)");break}s&&c&&(s=!1)}t&&s&&r.push(P(a,[e.join('", "')]))}else r.push(P(a,["undefined"]));return{value:i,isSet:o,isValid:!r.length,errors:r}}},F=function(e){return function(t){var i=[],n=Object.keys(e).filter((function(e){return isNaN(Number(e))})).map((function(t){return e[t]}));return n.some((function(e){return e===t}))||i.push(P(d.enum,["["+n.join(",")+"]"])),{value:t,isSet:!0,isValid:!i.length,errors:i}}},C={NUMBER:{type:d.number,method:D},INTEGER:{type:d.integer,method:function(e){var t=[];e=A(e);var i=parseInt(String(e),10);return e!==i&&t.push(d.integer),{value:i,isSet:!0,isValid:!t.length,errors:t}}},INTEGER_UNLIMITED:{type:d.integerUnlimited,method:function(e){var t=e,i=[];return(e=A(e))!==(t=Number.isFinite(e)?parseInt(String(e),10):e)&&i.push(d.integerUnlimited),{value:t,isSet:!0,isValid:!i.length,errors:i}}},MORE_OR_EQUAL:function(e,t){return{type:d.moreOrEqual,method:$(e,t)}},BOOLEAN:{type:d.boolean,method:function(e){var t=[],i=e;return"true"===e?i=!0:"false"===e&&(i=!1),"boolean"!=typeof i&&t.push(d.boolean),{value:i,isSet:!0,isValid:!t.length,errors:t}}},OBJECT:{type:d.object,method:function(e){var t=[];return"[object Object]"!==Object.prototype.toString.call(e)&&t.push(d.object),{value:e,isSet:!0,isValid:!t.length,errors:t}}},ITEM_LIST:{type:d.itemList,method:function(e){var t=e,i=[];if(Array.isArray(e))if(e.length){if(e.length>1){var n=typeof e[0];e.some((function(e){return typeof e!==n}))&&i.push(P(d.itemList,["of items of the same type"]))}}else i.push(P(d.itemList,["with at least 1 item"]));else i.push(d.itemList),t=[];return{value:t,isSet:!0,isValid:!i.length,errors:i}}},ELEMENT:{type:d.element,method:function(e){var t=[];return e instanceof Element||e instanceof HTMLDocument||t.push(d.element),{value:e,isSet:!0,isValid:!t.length,errors:t}}},FUNC:{type:d.function,method:T},FUNC_WITH_X_ARGUMENTS:function(e){return{type:d.funcOfxArguments,method:(t=e,function(e){var i=T(e);if(!i.isValid)return i;var n=[];return(e=i.value).length!==t&&n.push(P(d.funcOfxArguments,[String(t)])),{value:e,isSet:!0,isValid:!n.length,errors:n}})};var t},FUNC_WITH_X_AND_MORE_ARGUMENTS:function(e){return{type:d.funcOfxAndMoreArguments,method:(t=e,function(e){var i=T(e);if(!i.isValid)return i;var n=[];return(e=i.value).length<t&&n.push(P(d.funcOfxArguments,[String(t)])),{value:e,isSet:!0,isValid:!n.length,errors:n}})};var t},FUNC_WITH_X_TO_Y_ARGUMENTS:function(e,t){return{type:d.funcOfXToYArguments,method:R(e,t)}},ONE_OF_CAN:function(e){return{type:d.oneOfCan,method:j(e,!1)}},ONE_OF_MUST:function(e){return{type:d.oneOfMust,method:j(e,!0)}},OR:function(e){return{type:d.or,method:(t=e,function(e){var i=[];return t.every((function(t){return!t.method(e).isValid}))&&i.push(t.map((function(e){return e.type})).join(" OR ")),{value:e,isSet:!0,isValid:!i.length,errors:i}})};var t},ENUM:function(e){return{type:d.enum,method:F(e)}}},L=function(){function e(e){this.params={},this.contextErrors=[],this.errors=[],this.isValid=!0,this.setContext(e)}return e.prototype.setContext=function(e){e&&"[object Object]"===Object.prototype.toString.call(e)?this.isValidContext=!0:(this.setCommonError("context is not an object"),this.isValidContext=!1),this.context=e},e.prototype.setValidity=function(){var e=this;this.errors=Object.keys(this.params).reduce((function(t,i){return s(s([],o(t)),o(e.params[i].errors))}),[]),this.isValid=!this.errors.length},e.prototype.setCommonError=function(e){this.contextErrors.push(e),this.errors.push(e),this.isValid=!1},e.prototype.setParam=function(e,t){t.isValid||(t.errors=t.isSet?t.errors.map((function(t){return'"'+e+'" '+t})):['"'+e+'" must be set']),this.params[e]=t,this.setValidity()},e.prototype.showErrors=function(){return this.errors.length?"validation failed: "+this.errors.join(", "):""},e}(),B=function(e,t,i){var n=e.value,r=e.errors,a=t.method(n,i),l=s(s([],o(r)),o(a.errors));return{value:a.value,isSet:a.isSet,isValid:!l.length,errors:l}},_=function(e,t){var i=void 0===e,n=!t.mandatory&&void 0!==t.defaultValue;return{value:i?n?t.defaultValue:void 0:e,isSet:!i||n,isValid:!i||!t.mandatory,errors:[]}},U=function(e,t,i){var n,o,s=_(e[t],i);if(s.isSet)try{for(var a=r(Object.values(i.validators)),l=a.next();!l.done;l=a.next()){var u=l.value,c=B(s,u,e);if(!c.isValid&&void 0!==i.defaultValue)return{value:i.defaultValue,isSet:!0,isValid:!0,errors:[]};Object.assign(s,c)}}catch(e){n={error:e}}finally{try{l&&!l.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}else{var f=i.validators.find((function(e){return e.type===d.oneOfMust}));if(f)return B(s,f,e)}return s},W=function(e,t){var i=new L(e);return Object.entries(t).forEach((function(e){var t=o(e,2),n=t[0],r=t[1];return i.setParam(n,i.isValidContext?U(i.context,n,r):_(void 0,r))})),i},q=C.OBJECT,H=C.FUNC_WITH_X_AND_MORE_ARGUMENTS;!function(e){e.get="get",e.settings="settings",e.devSettings="devSettings"}(V||(V={}));var G,X,Y,J,Q,Z=((M={})[V.get]={validators:[H(2)],mandatory:!0},M[V.settings]={validators:[q]},M[V.devSettings]={validators:[q]},M),K=C.NUMBER,ee=C.INTEGER,te=C.INTEGER_UNLIMITED,ie=C.MORE_OR_EQUAL,ne=C.BOOLEAN,re=C.ELEMENT,oe=C.FUNC,se=C.OR,ae=C.ENUM;!function(e){e.adapter="adapter",e.startIndex="startIndex",e.minIndex="minIndex",e.maxIndex="maxIndex",e.itemSize="itemSize",e.bufferSize="bufferSize",e.padding="padding",e.infinite="infinite",e.horizontal="horizontal",e.windowViewport="windowViewport",e.viewportElement="viewportElement",e.inverse="inverse",e.onBeforeClip="onBeforeClip",e.sizeStrategy="sizeStrategy"}(J||(J={})),function(e){e.debug="debug",e.immediateLog="immediateLog",e.logProcessRun="logProcessRun",e.logTime="logTime",e.throttle="throttle",e.initDelay="initDelay",e.initWindowDelay="initWindowDelay",e.cacheData="cacheData",e.cacheOnReload="cacheOnReload",e.changeOverflow="changeOverflow",e.dismissOverflowAnchor="dismissOverflowAnchor"}(Q||(Q={}));var le,ue,ce,fe,de,pe,he,ge,me,ve,xe,be,ye,Ie,we=((G={})[J.itemSize]=1,G[J.bufferSize]=1,G[J.padding]=.01,G[Q.throttle]=0,G[Q.initDelay]=0,G[Q.initWindowDelay]=0,G),Se=((X={})[J.adapter]={validators:[ne],defaultValue:!1},X[J.startIndex]={validators:[ee],defaultValue:1},X[J.minIndex]={validators:[te],defaultValue:-1/0},X[J.maxIndex]={validators:[te],defaultValue:1/0},X[J.itemSize]={validators:[ee,ie(we[J.itemSize],!0)],defaultValue:NaN},X[J.bufferSize]={validators:[ee,ie(we[J.bufferSize],!0)],defaultValue:5},X[J.padding]={validators:[K,ie(we[J.padding],!0)],defaultValue:.5},X[J.infinite]={validators:[ne],defaultValue:!1},X[J.horizontal]={validators:[ne],defaultValue:!1},X[J.windowViewport]={validators:[ne],defaultValue:!1},X[J.viewportElement]={validators:[se([re,oe])],defaultValue:null},X[J.inverse]={validators:[ne],defaultValue:!1},X[J.onBeforeClip]={validators:[oe],defaultValue:null},X[J.sizeStrategy]={validators:[ae(e.SizeStrategy)],defaultValue:e.SizeStrategy.Average},X),ze=((Y={})[Q.debug]={validators:[ne],defaultValue:!1},Y[Q.immediateLog]={validators:[ne],defaultValue:!0},Y[Q.logProcessRun]={validators:[ne],defaultValue:!1},Y[Q.logTime]={validators:[ne],defaultValue:!1},Y[Q.throttle]={validators:[ee,ie(we[Q.throttle],!0)],defaultValue:40},Y[Q.initDelay]={validators:[ee,ie(we[Q.initDelay],!0)],defaultValue:1},Y[Q.initWindowDelay]={validators:[ee,ie(we[Q.initWindowDelay],!0)],defaultValue:40},Y[Q.cacheData]={validators:[ne],defaultValue:!1},Y[Q.cacheOnReload]={validators:[ne],defaultValue:!1},Y[Q.changeOverflow]={validators:[ne],defaultValue:!1},Y[Q.dismissOverflowAnchor]={validators:[ne],defaultValue:!0},Y);!function(e){e.init="init",e.scroll="scroll",e.start="start",e.preFetch="preFetch",e.fetch="fetch",e.postFetch="postFetch",e.render="render",e.preClip="preClip",e.clip="clip",e.adjust="adjust",e.end="end"}(le||(le={})),function(e){e.reset="adapter.reset",e.reload="adapter.reload",e.append="adapter.append",e.prepend="adapter.prepend",e.check="adapter.check",e.remove="adapter.remove",e.replace="adapter.replace",e.update="adapter.update",e.clip="adapter.clip",e.insert="adapter.insert",e.fix="adapter.fix"}(ue||(ue={})),function(e){e.start="start",e.next="next",e.done="done",e.error="error"}(ce||(ce={}));var ke,Ne=C.INTEGER,Ee=C.INTEGER_UNLIMITED,Oe=C.BOOLEAN,Me=C.OBJECT,Ve=C.ITEM_LIST,Pe=C.FUNC_WITH_X_ARGUMENTS,Ae=C.FUNC_WITH_X_AND_MORE_ARGUMENTS,De=C.FUNC_WITH_X_TO_Y_ARGUMENTS,$e=C.ONE_OF_MUST,Te=C.ONE_OF_CAN,Re=C.OR;ke||(ke={});var je,Fe=((fe={})[V.get]={validators:[Ae(2)]},fe[V.settings]={validators:[Me]},fe[V.devSettings]={validators:[Me]},fe);!function(e){e.reloadIndex="reloadIndex"}(je||(je={}));var Ce,Le=((de={})[je.reloadIndex]={validators:[Ne]},de);!function(e){e.items="items",e.bof="bof",e.eof="eof"}(Ce||(Ce={}));var Be,_e=((pe={})[Ce.items]={validators:[Ve],mandatory:!0},pe[Ce.bof]={validators:[Oe,Te([Ce.eof])]},pe[Ce.eof]={validators:[Oe,Te([Ce.bof])]},pe);!function(e){e.predicate="predicate",e.indexes="indexes",e.increase="increase"}(Be||(Be={}));var Ue,We=((he={})[Be.predicate]={validators:[Pe(1),$e([Be.indexes])]},he[Be.indexes]={validators:[Ve,$e([Be.predicate])]},he[Be.increase]={validators:[Oe],defaultValue:!1},he);!function(e){e.backwardOnly="backwardOnly",e.forwardOnly="forwardOnly"}(Ue||(Ue={}));var qe,He=((ge={})[Ue.backwardOnly]={validators:[Oe,Te([Ue.forwardOnly])],defaultValue:!1},ge[Ue.forwardOnly]={validators:[Oe,Te([Ue.backwardOnly])],defaultValue:!1},ge);!function(e){e.items="items",e.before="before",e.after="after",e.decrease="decrease"}(qe||(qe={}));var Ge,Xe=((me={})[qe.items]={validators:[Ve],mandatory:!0},me[qe.before]={validators:[Pe(1),$e([qe.after])]},me[qe.after]={validators:[Pe(1),$e([qe.before])]},me[qe.decrease]={validators:[Oe],defaultValue:!1},me);!function(e){e.items="items",e.predicate="predicate",e.fixRight="fixRight"}(Ge||(Ge={}));var Ye,Je=((ve={})[qe.items]={validators:[Ve],mandatory:!0},ve[Ge.predicate]={validators:[Pe(1)],mandatory:!0},ve[Ge.fixRight]={validators:[Oe],defaultValue:!1},ve);!function(e){e.predicate="predicate",e.fixRight="fixRight"}(Ye||(Ye={}));var Qe,Ze=((xe={})[Ye.predicate]={validators:[Pe(1)],mandatory:!0},xe[Ye.fixRight]={validators:[Oe],defaultValue:!1},xe);!function(e){e.scrollPosition="scrollPosition",e.minIndex="minIndex",e.maxIndex="maxIndex",e.updater="updater",e.scrollToItem="scrollToItem",e.scrollToItemOpt="scrollToItemOpt"}(Qe||(Qe={}));var Ke=((be={})[Qe.scrollPosition]={validators:[Ee]},be[Qe.minIndex]={validators:[Ee]},be[Qe.maxIndex]={validators:[Ee]},be[Qe.updater]={validators:[De(1,2)]},be[Qe.scrollToItem]={validators:[Pe(1)]},be[Qe.scrollToItemOpt]={validators:[Re([Oe,Me])]},be),et=((ye={})[ue.reset]=V,ye[ue.reload]=je,ye[ue.append]=Ce,ye[ue.prepend]=Ce,ye[ue.check]=ke,ye[ue.remove]=Be,ye[ue.clip]=Ue,ye[ue.insert]=qe,ye[ue.replace]=Ge,ye[ue.update]=Ye,ye[ue.fix]=Qe,ye),tt=((Ie={})[ue.reset]=Fe,Ie[ue.reload]=Le,Ie[ue.append]=_e,Ie[ue.prepend]=_e,Ie[ue.check]={},Ie[ue.remove]=We,Ie[ue.clip]=He,Ie[ue.insert]=Xe,Ie[ue.replace]=Je,Ie[ue.update]=Ze,Ie[ue.fix]=Ke,Ie),it=function(){function e(e,t,i){this.parseInput(e,Se),this.parseInput(t,ze),this.instanceIndex=i,this.initializeDelay=this.getInitializeDelay(),this.viewport=this.getViewport()}return e.prototype.parseInput=function(e,t){var i=this,n=W(e,t);if(!n.isValid)throw new Error("Invalid settings");Object.entries(n.params).forEach((function(e){var t,n=o(e,2),r=n[0],s=n[1];return Object.assign(i,((t={})[r]=s.value,t))}))},e.prototype.getInitializeDelay=function(){var e=0;return this.windowViewport&&this.initWindowDelay&&!("scrollRestoration"in history)&&(e=this.initWindowDelay),this.initDelay>0&&(e=Math.max(e,this.initDelay)),e},e.prototype.getViewport=function(){if("function"!=typeof this.viewportElement)return this.viewportElement;var e=this.viewportElement(),t=U({value:e},"value",{validators:[C.ELEMENT]});return t.isValid?t.value:null},e}(),nt=function(e){var t;return(t=function(){}).process=e,t},rt=function(e){var t;return(t=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return i(r,t),r.parseInput=function(t,i,r){void 0===r&&(r=!1);var s={data:W(i,tt[e])};return s.data.isValid?s.params=Object.entries(s.data.params).reduce((function(e,t){var i,r=o(t,2),s=r[0],a=r[1].value;return n(n({},e),((i={})[s]=a,i))}),{}):(t.logger.log((function(){return s.data.showErrors()})),r||t.workflow.call({process:e,status:ce.error,payload:{error:'Wrong argument of the "'+e+'" method call'}})),s},r}(nt(e))).process=e,t},ot=[le.init,ue.reset,ue.reload],st=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e,i){var n=e.state.cycle,r=e.workflow,o=ot.includes(i);e.logger.logCycle(!0),n.start(o,i),r.call({process:t.process,status:ce.next})},t}(nt(le.init)),at=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return i(r,t),r.run=function(e,t){var i=e.workflow,n=e.viewport.scrollPosition;r.onSynthetic(e,n)||r.onThrottle(e,n,(function(){return r.onScroll(e,i)}))},r.onSynthetic=function(e,t){var i=e.state.scrollState,n=i.syntheticPosition;if(null!==n){if(i.syntheticFulfill&&(i.syntheticPosition=null),!i.syntheticFulfill||n===t)return e.logger.log((function(){return["skipping scroll",t,"["+(i.syntheticFulfill?"":"pre-")+"synthetic]"]})),!0;e.logger.log((function(){return["synthetic scroll has been fulfilled:",t,t<n?"<":">",n]}))}return!1},r.onThrottle=function(t,i,n){var o=t.state.scrollState,s=t.settings.throttle,a=t.logger;o.current=r.getScrollEvent(i,o.previous);var l=o.current,u=l.direction,c=l.time,f=o.previous?c-o.previous.time:1/0,d=s-f,p=isFinite(d)&&d>0,h=!!o.scrollTimer;if(a.log((function(){return[u===e.Direction.backward?"⤴":"⤵",i,p?f+"ms":"0ms",p?h?"delayed":"/ "+d+"ms delay":""]})),!p)return o.scrollTimer&&(clearTimeout(o.scrollTimer),o.scrollTimer=null),void n();h||(o.scrollTimer=setTimeout((function(){a.log((function(){var n=r.getScrollEvent(t.viewport.scrollPosition,o.current);return[n.direction===e.Direction.backward?"⤴":"⤵",n.position,n.time-c+"ms","triggered by timer set on",i]})),o.scrollTimer=null,n()}),d))},r.getScrollEvent=function(t,i){var n=Number(new Date),r=e.Direction.forward;return i&&(t===i.position?r=i.direction:t<i.position&&(r=e.Direction.backward)),{position:t,direction:r,time:n}},r.onScroll=function(e,t){var i=e.state,o=i.scrollState,s=i.cycle;o.previous=n({},o.current),o.current=null,s.busy.get()?e.logger.log((function(){return["skipping scroll",o.previous.position,"[pending]"]})):t.call({process:r.process,status:ce.next})},r}(nt(le.scroll)),lt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e,i){var n=e.datasource,r=e.buffer,o=e.viewport.paddings,s=e.state.cycle;if(i){var a=t.parseInput(e,i).data;if(!a.isValid)return;var l=i instanceof O;Object.keys(V).forEach((function(e){var t=a.params[e],i=n;(t.isSet||l&&i[e])&&(i[e]=t.value)}))}r.reset(!0),o.backward.reset(),o.forward.reset();var u={datasource:n};s.busy.get()&&(u.finalize=!0,s.interrupter=t.process),e.workflow.call({process:t.process,status:ce.next,payload:u})},t}(rt(ue.reset)),ut=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e,i){var n=e.viewport,r=e.state,o=e.buffer,s=t.parseInput(e,{reloadIndex:i},!0).params;o.reset(!1,s?s.reloadIndex:void 0),n.reset(o.startIndex);var a={};r.cycle.busy.get()&&(r.scrollState.cleanupTimers(),a.finalize=!0,r.cycle.interrupter=t.process),e.workflow.call({process:t.process,status:ce.next,payload:a})},t}(rt(ue.reload)),ct=function(){function e(e,t,i){this.container={$index:e,data:t},this.nodeId=String(e),this.routines=i,this.invisible=!0,this.toRemove=!1,this.toInsert=!1}return Object.defineProperty(e.prototype,"$index",{get:function(){return this.container.$index},set:function(e){this.container.$index=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this.container.data},set:function(e){this.container.data=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"element",{get:function(){return this.container.element},set:function(e){this.container.element=e},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){delete this.container.element},e.prototype.setSize=function(){this.size=this.routines.getSize(this.element)},e.prototype.hide=function(){this.element&&this.routines.hideElement(this.element)},e.prototype.scrollTo=function(e){this.element&&this.routines.scrollTo(this.element,e)},e.prototype.updateIndex=function(e){this.$index=e,this.nodeId=String(e)},e.prototype.get=function(){return this.container},e}(),ft=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e,i){var n=i.process,r=i.options,o=t.parseInput(e,r).params;if(o){var s=o.items,a=o.bof,l=o.eof,u=n!==ue.append,c=!!(u?a:l);if(u&&c&&!e.buffer.bof.get()||!u&&c&&!e.buffer.eof.get())return t.doVirtualize(e,s,u),void e.workflow.call({process:t.process,status:ce.done});t.simulateFetch(e,s,c,u),e.workflow.call({process:t.process,status:ce.next})}},t.doVirtualize=function(e,t,i){var n=e.buffer,r=e.viewport.paddings,o=i?"absMinIndex":"absMaxIndex";if(isFinite(n[o])){var s=t.length*n.defaultSize,a=i?r.backward:r.forward;n[o]+=(i?-1:1)*t.length,a.size+=s,i&&(e.viewport.scrollPosition+=s),e.logger.log((function(){return"buffer."+[o]+" value is set to "+n[o]})),e.logger.stat("after virtual "+(i?"prepend":"append"))}},t.simulateFetch=function(e,t,i,n){for(var r=e.buffer,o=e.state.fetch,s=n?"absMinIndex":"absMaxIndex",a=r.getIndexToAdd(i,n),l=r[s],u=[],c=0;c<t.length;c++){var f=new ct(a,t[c],e.routines);isFinite(l)&&(n&&a<l||!n&&a>l)&&(l+=n?-1:1),(n?Array.prototype.unshift:Array.prototype.push).apply(u,[f]),a+=n?-1:1}return l!==r[s]&&(r[s]=l,e.logger.log((function(){return"buffer."+s+" value is set to "+r[s]}))),(n?o.prepend:o.append).call(o,u),(n?r.prepend:r.append).call(r,u),o.first.indexBuffer=isNaN(r.firstIndex)?a:r.firstIndex,o.last.indexBuffer=isNaN(r.lastIndex)?a:r.lastIndex,!0},t}(rt(ue.append)),dt=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return i(n,t),n.run=function(t){var i=t.workflow,r=t.buffer,o=t.state.fetch,s=t.viewport,a=1/0,l=-1/0;if(r.items.forEach((function(e){var t=e.size;e.setSize(),e.size!==t&&(r.cacheItem(e),a=Math.min(a,e.$index),l=Math.max(l,e.$index))})),Number.isFinite(a)){o.first.indexBuffer=r.firstIndex,o.last.indexBuffer=r.lastIndex;var u=s.getEdgeVisibleItem(r.items,e.Direction.backward),c=u.index,f=u.diff;o.firstVisibleIndex=c,isNaN(c)||(o.firstVisibleItemDelta=-r.getSizeByIndex(c)+f),o.check(r.items.filter((function(e){return e.$index>=a&&e.$index<=l})))}t.logger.stat("check"),i.call({process:n.process,status:Number.isFinite(a)?ce.next:ce.done})},n}(rt(ue.check)),pt=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return i(n,t),n.run=function(e,t){var i=n.parseInput(e,t).params;if(i){var r=n.doRemove(e,i);e.workflow.call({process:n.process,status:r?ce.next:ce.done})}},n.doRemove=function(e,t,i){void 0===i&&(i=!1);var r=e.state.fetch;r.firstVisibleIndex=NaN;var o=n.removeBufferedItems(e,t);t.indexes&&t.indexes.length&&(t.indexes=t.indexes.filter((function(e){return!o.includes(e)})));var s=o.length>0,a=n.removeVirtualItems(e,t,i);return!(!s&&!a)&&(isNaN(r.firstVisibleIndex)||r.remove(),e.logger.stat("after remove"),!0)},n.removeBufferedItems=function(e,t){var i=t.predicate,r=t.indexes,o=t.increase,s=[];if(i&&(s=n.runPredicateOverBuffer(e,i,!!o)),r){s=n.runPredicateOverBuffer(e,(function(e){var t=e.$index;return r.indexOf(t)>=0}),!!o)}return s},n.runPredicateOverBuffer=function(t,i,r){for(var o=t.viewport,s=t.buffer,a=t.buffer.items,l=t.state.fetch,u=[],c=0;c<a.length;c++){var f=a[c];if(i(f.get()))u.push(f),f.toRemove=!0;else if(u.length)break}if(!u.length)return[];var d=u[0].$index,p=u[u.length-1].$index,h=o.getEdgeVisibleItem(s.items,e.Direction.backward),g=h.index,m=h.diff;(g<d||g>p)&&(l.firstVisibleIndex=g,l.firstVisibleItemDelta=-s.getSizeByIndex(g)+m),isNaN(l.firstVisibleIndex)&&p<s.finiteAbsMaxIndex&&(l.firstVisibleIndex=p+1),isNaN(l.firstVisibleIndex)&&d>s.finiteAbsMinIndex&&(l.firstVisibleIndex=d-1),isNaN(l.firstVisibleIndex)&&(l.firstVisibleIndex=s.finiteAbsMinIndex);var v=u.map((function(e){return e.$index}));return t.logger.log((function(){return"going to remove "+u.length+" item(s) from Buffer: ["+v.join(",")+"]"})),s.removeItems(v,r,!1),s.checkDefaultSize(),n.shiftFirstVisibleIndex(t,v,r),u.forEach((function(e){return e.hide()})),v},n.removeVirtualItems=function(t,i,r){var o=i.indexes,s=i.increase;if(!o||!o.length)return!1;for(var a=t.buffer,l=t.viewport,u=t.state.fetch,c=a.finiteAbsMinIndex,f=a.firstIndex,d=a.finiteAbsMaxIndex,p=a.lastIndex,h=[],g=NaN,m=0,v=o.length;m<v;m++){if((b=o[m])>=c&&!isNaN(f)&&b<f)h.push(b);else{if(!(b<=d&&!isNaN(p)&&b>p))continue;h.push(b)}if(r&&!isNaN(g)&&Math.abs(g-b)>1)break;g=b}if(!h.length)return!1;if(isNaN(u.firstVisibleIndex)){var x=l.getEdgeVisibleItem(a.items,e.Direction.backward),b=x.index,y=x.diff;isNaN(b)||(u.firstVisibleIndex=b,u.firstVisibleItemDelta=-a.getSizeByIndex(b)+y)}return t.logger.log((function(){return"going to remove "+h.length+" item(s) virtually"})),a.removeItems(h,!!s,!0),a.checkDefaultSize(),n.shiftFirstVisibleIndex(t,h,!!s),!0},n.shiftFirstVisibleIndex=function(e,t,i){var n=e.state.fetch;if(!isNaN(n.firstVisibleIndex)){var r=t.reduce((function(e,t){return e+(i&&t>n.firstVisibleIndex||!i&&t<n.firstVisibleIndex?1:0)}),0);n.firstVisibleIndex=n.firstVisibleIndex+(i?r:-r)}},n}(rt(ue.remove)),ht=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e,i){var n=t.parseInput(e,i).params;e.state.clip.forceForward=!(n&&n.backwardOnly),e.state.clip.forceBackward=!(n&&n.forwardOnly),e.workflow.call({process:t.process,status:ce.next})},t}(rt(ue.clip)),gt=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return i(n,t),n.run=function(e,t){var i=n.parseInput(e,t).params;if(i){var r=n.doUpdate(e,i);e.workflow.call({process:n.process,status:r?ce.next:ce.done})}},n.doUpdate=function(t,i){var n=t.buffer,r=t.viewport,a=t.state.fetch,l=t.routines,u=t.logger;if(!n.items)return u.log((function(){return"no items in Buffer"})),!1;var c=s([],o(n.items)),f=r.getEdgeVisibleItem(n.items,e.Direction.backward),d=f.item,p=f.index,h=f.diff,g=n.updateItems(i.predicate,(function(e,t){return new ct(e,t,l)}),p,!!i.fixRight),m=0,v=n.get(g);d&&d===v&&(m=-n.getSizeByIndex(g)+h);var x=c.filter((function(e){return e.toRemove}));x.forEach((function(e){return e.hide()})),u.log((function(){return x.length?"items to remove: ["+x.map((function(e){return e.$index})).join(",")+"]":"no items to remove"}));var b=n.items.filter((function(e){return e.toInsert}));return u.log((function(){return b.length?"items to render: ["+b.map((function(e){return e.$index})).join(",")+"]":"no items to render"})),a.update(g,m,b,x),!!x.length||!!b.length},n}(rt(ue.update)),mt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e,i){var n=t.parseInput(e,i).params;if(n){var r=t.doInsert(e,n);e.workflow.call({process:t.process,status:r?ce.next:ce.done})}},t.doInsert=function(e,t){var i=t.before,n=t.after,r=t.items,a=t.decrease,l=i||n,u=e.buffer.items.find((function(e){return l(e.get())}));if(!u)return e.logger.log("no item to insert found"),!1;var c=u.$index,f={predicate:function(e){var t=e.$index,n=e.data;return c!==t||(i?s(s([],o(r)),[n]):s([n],o(r)))},fixRight:a};return gt.doUpdate(e,f)},t}(rt(ue.insert)),vt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e,i){var n=t.parseInput(e,i).params;if(n){var r=t.doReplace(e,n);e.workflow.call({process:t.process,status:r?ce.next:ce.done})}},t.doReplace=function(e,t){var i=e.buffer.items.filter((function(e){return t.predicate(e)})).map((function(e){return e.$index}));if(!i.length)return e.logger.log("no items to be replaced"),!1;var n=!1,r={predicate:function(e){var r=e.$index;return!i.includes(r)||!n&&(n=!0,t.items)},fixRight:t.fixRight};return gt.doUpdate(e,r)},t}(rt(ue.replace)),xt=et[ue.fix],bt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e,i){var n=e.workflow,r=t.parseInput(e,i),s=r.data;r.params&&(Object.entries(s.params).forEach((function(i){var n=o(i,2),r=n[0],a=n[1];a.isSet&&a.isValid&&t.runByType(e,r,a.value,s)})),n.call({process:t.process,status:ce.done}))},t.runByType=function(e,i,n,r){switch(i){case xt.scrollPosition:return t.setScrollPosition(e,n);case xt.minIndex:return t.setMinIndex(e,n);case xt.maxIndex:return t.setMaxIndex(e,n);case xt.updater:return t.updateItems(e,n);case xt.scrollToItem:if(r.params){var o=r.params[xt.scrollToItemOpt],s=o?o.value:void 0;return t.scrollToItem(e,n,s)}return;case xt.scrollToItemOpt:return}},t.setScrollPosition=function(e,t){var i=e.viewport,n=t;t===-1/0?n=0:t===1/0&&(n=i.getScrollableSize()),i.setPosition(n)},t.setMinIndex=function(e,t){var i=e.buffer;e.settings.minIndex=t,i.absMinIndex=t},t.setMaxIndex=function(e,t){var i=e.buffer;e.settings.maxIndex=t,i.absMaxIndex=t},t.updateItems=function(e,t){var i=e.buffer,n=e.logger,r=!1,a=function(){return r=!0};i.items.forEach((function(e){return t(e.get(),a)})),r&&(n.log((function(){return"update Buffer.items reference"})),i.items=s([],o(i.items)))},t.scrollToItem=function(e,t,i){var n=e.buffer.items.find((function(e){return t(e.get())}));n?n.scrollTo(i):e.logger.log((function(){return"scrollToItem cancelled, item not found"}))},t}(rt(ue.fix)),yt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e){var i=e.state.startInnerLoop();e.workflow.call({process:t.process,status:ce.next,payload:i})},t}(nt(le.start)),It=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return i(n,t),n.run=function(e){var t=e.workflow,i=e.buffer,r=e.state,o=r.fetch,s=r.cycle;o.minIndex=i.minIndex,n.setPositionsAndIndexes(e),n.skipBufferedItems(e),e.settings.infinite&&n.checkBufferGaps(e),n.checkFetchPackSize(e),n.setFetchDirection(e),t.call({process:n.process,status:n.getStatus(e),payload:{process:s.initiator}})},n.setPositionsAndIndexes=function(e){n.setPositions(e),n.setFirstIndex(e),n.setLastIndex(e),e.logger.fetch()},n.setPositions=function(e){var t=e.state.fetch.positions,i=e.viewport,r=i.getBufferPadding();t.before=i.scrollPosition,t.startDelta=n.getStartDelta(e),t.relative=t.before-t.startDelta,t.start=t.relative-r,t.end=t.relative+i.getSize()+r},n.getStartDelta=function(e){var t=e.buffer,i=e.viewport.offset,n=0;if(i&&(n+=i),!t.defaultSize)return n;for(var r=t.finiteAbsMinIndex;r<t.startIndex;r++)n+=t.getSizeByIndex(r);return e.logger.log((function(){return s(["start delta is "+n],o(i?[" (+"+i+" offset)"]:[]))})),n},n.setFirstIndex=function(e){var t=e.state,i=e.buffer,n=t.fetch,r=n.positions.start,o=n.first,s=i.startIndex,a=0;if(t.cycle.innerLoop.isInitial)e.logger.log("skipping fetch backward direction [initial loop]");else if(i.defaultSize)for(var l=a,u=s;;){if(r>=0){var c=i.getSizeByIndex(u);if(l+c-r>0){s=u,a=l;break}if(l+=c,++u<i.absMinIndex)break}if(r<0){if(--u<i.absMinIndex)break;if(s=u,a=l-=i.getSizeByIndex(u),l-r<=0)break}}else e.logger.log("skipping fetch backward direction [no item size]");o.index=o.indexBuffer=Math.max(s,i.absMinIndex),o.position=a},n.setLastIndex=function(e){var t,i=e.state,n=i.fetch,r=i.cycle,o=e.buffer,s=e.settings,a=n.positions,l=a.relative,u=a.end,c=n.first,f=n.last;if(o.defaultSize){var d=c.indexBuffer,p=c.position;for(t=d;;){t=d;var h=o.getSizeByIndex(d);if(p+=h,isNaN(n.firstVisibleIndex)&&p>l&&(n.firstVisibleIndex=d,r.innerLoop.isInitial||(n.firstVisibleItemDelta=p-h-l)),p>=u)break;if(d++>o.absMaxIndex)break}}else t=o.startIndex+s.bufferSize-1,e.logger.log("forcing fetch forward direction [no item size]");f.index=f.indexBuffer=Math.min(t,o.absMaxIndex)},n.skipBufferedItems=function(e){var t=e.buffer;if(t.size){for(var i=e.state.fetch,n=i.first.index,r=i.last.index,o=[[]],s=0,a=n;a<=r;a++)t.get(a)?o[s].length&&(o[++s]=[]):o[s].push(a);var l=o[0];o[0].length&&o[1]&&o[1].length&&(i.hasAnotherPack=!0,o[1].length>=o[0].length&&(l=o[1])),i.first.index=Math.max(l[0],t.absMinIndex),i.last.index=Math.min(l[l.length-1],t.absMaxIndex),i.first.index===n&&i.last.index===r||e.logger.fetch("after Buffer flushing")}},n.checkBufferGaps=function(e){var t=e.buffer,i=e.state.fetch;if(t.size){var n=i.first.index,r=t.lastIndex;n>r&&(i.first.index=i.first.indexBuffer=r+1);var o=t.firstIndex,s=i.last.index;s<o&&(i.last.index=i.last.indexBuffer=o-1),i.first.index===n&&i.last.index===s||e.logger.fetch("after Buffer filling (no clip case)")}},n.checkFetchPackSize=function(e){var t=e.buffer,i=e.state.fetch;if(i.shouldFetch){var r=i.first.index,o=i.last.index,s=e.settings.bufferSize-(o-r+1);if(!(s<=0)){if(!t.size||o>t.items[0].$index){var a=Math.min(o+s,t.absMaxIndex);a>o&&(i.last.index=i.last.indexBuffer=a)}else{var l=Math.max(r-s,t.absMinIndex);l<r&&(i.first.index=i.first.indexBuffer=l)}i.first.index===r&&i.last.index===o||(e.logger.fetch("after bufferSize adjustment"),n.skipBufferedItems(e))}}},n.setFetchDirection=function(t){var i=t.buffer,n=t.state.fetch;if(n.last.index){var r=e.Direction.forward;i.size&&(r=n.last.index<i.items[0].$index?e.Direction.backward:e.Direction.forward),n.direction=r,t.logger.log((function(){return'fetch direction is "'+r+'"'}))}},n.getStatus=function(e){var t=e.state,i=t.cycle,n=t.fetch;return i.initiator===ue.clip?(e.logger.log((function(){return'going to skip fetch due to "'+ue.clip+'" process'})),ce.next):n.shouldFetch?(e.logger.log((function(){return"going to fetch "+n.count+" items started from index "+n.index})),ce.next):ce.done},n}(nt(le.preFetch)),wt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e){var i=e.workflow,n={success:function(n){e.logger.log((function(){return"resolved "+n.length+" items (index = "+e.state.fetch.index+", count = "+e.state.fetch.count+")"})),e.state.fetch.newItemsData=n,i.call({process:t.process,status:ce.next})},fail:function(e){return i.call({process:t.process,status:ce.error,payload:{error:e}})}},r=t.get(e);t.complete(e,n,r)},t.complete=function(e,t,i){if(Object.prototype.hasOwnProperty.call(i,"data")){var n=i,r=n.data,o=n.error;n.isError?t.fail(o):t.success(r||[])}else{var s=e.state,a=s.scrollState,l=s.fetch,u=e.viewport;null===a.positionBeforeAsync&&(a.positionBeforeAsync=u.scrollPosition),l.cancel=function(){t.success=function(){return null},t.fail=function(){return null}},i.then((function(e){return t.success(e)}),(function(e){return t.fail(e)}))}},t.get=function(e){var t,i,n,r,o=e.datasource.get,s=e.state.fetch,a=function(e){n?n(e):t=e||null},l=function(e){r?r(e):i=e||null},u=o(s.index,s.count,a,l);if(u&&"object"==typeof u&&null!==u){if("function"==typeof u.then)return u;if("function"==typeof u.subscribe)var c=u.subscribe(a,l,(function(){c&&"object"==typeof c&&"function"==typeof c.unsubscribe&&c.unsubscribe()}))}return t||i?{data:i?null:t||[],error:i,isError:!!i}:new Promise((function(e,t){n=e,r=t}))},t}(nt(le.fetch)),St=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e){var i=e.workflow;t.setItems(e)?(t.setBufferLimits(e),i.call({process:t.process,status:e.state.fetch.hasNewItems?ce.next:ce.done})):i.call({process:t.process,status:ce.error,payload:{error:"Can't set buffer items"}})},t.setBufferLimits=function(e){var t=e.buffer,i=e.state,n=i.fetch,r=i.fetch.items,o=i.cycle.innerLoop,s=n.first.index,a=n.last.index;if(r.length){var l=r.length-1;s<r[0].$index&&(t.absMinIndex=r[0].$index),a>r[l].$index&&(t.absMaxIndex=r[l].$index)}else(a<t.minIndex||o.isInitial)&&(t.absMinIndex=t.minIndex),(s>t.maxIndex||o.isInitial)&&(t.absMaxIndex=t.maxIndex)},t.setItems=function(e){var t=e.buffer,i=e.state,n=i.fetch,r=i.cycle,o=n.newItemsData;if(!o||!o.length)return!0;var s=n.index;return o.length<n.count&&(r.innerLoop.isInitial?s=t.startIndex:n.first.index<t.minIndex&&(s=t.minIndex-o.length)),n.items=o.map((function(t,i){return new ct(s+i,t,e.routines)})),n.isPrepend=!!t.items.length&&t.items[0].$index>n.items[n.items.length-1].$index,t.setItems(n.items)},t}(nt(le.postFetch)),zt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e){var i=e.workflow,n=e.state,r=n.cycle,o=n.render,s=n.scrollState,a=e.viewport;e.logger.stat("before new items render"),null===s.positionBeforeAsync&&(s.positionBeforeAsync=a.scrollPosition),o.renderTimer=setTimeout((function(){o.renderTimer=null,t.doRender(e)?i.call({process:t.process,status:o.noSize?ce.done:ce.next,payload:{process:r.initiator}}):i.call({process:t.process,status:ce.error,payload:{error:"Can't associate item with element"}})}),0)},t.doRender=function(e){var i=e.state,n=i.fetch,r=i.render,o=e.viewport,s=e.buffer,a=e.logger;return r.positionBefore=o.scrollPosition,!(!n.isCheck&&(r.sizeBefore=o.getScrollableSize(),n.items.map((function(i){return t.processElement(e,i)})).some((function(e){return!e}))))&&(s.checkDefaultSize(),r.sizeAfter=o.getScrollableSize(),a.stat("after new items render"),a.log((function(){return r.noSize?"viewport size has not been changed":void 0})),!0)},t.processElement=function(e,t){var i=e.state.fetch,n=e.viewport,r=e.buffer,o=n.element.querySelector('[data-sid="'+t.nodeId+'"]');return!!o&&(t.element=o,t.element.style.left="",t.element.style.top="",t.element.style.position="",t.invisible=!1,t.setSize(),r.cacheItem(t),t.$index<i.minIndex&&(i.negativeSize+=t.size),!0)},t}(nt(le.render)),kt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.run=function(e){var i=e.workflow,n=e.viewport,r=e.state.scrollState;r.positionBeforeAdjust=n.scrollPosition,t.setPaddings(e),r.positionAfterAdjust=n.scrollPosition;var o=t.calculatePosition(e);t.setPosition(e,o,(function(){return i.call({process:t.process,status:ce.done})}))},t.setPaddings=function(e){var t,i,n=e.viewport,r=e.buffer,o=e.settings.inverse,s=e.state.fetch,a=r.getFirstVisibleItem(),l=r.getLastVisibleItem();a&&l?(t=a.$index,i=l.$index):i=(t=isNaN(s.firstVisibleIndex)?r.startIndex:s.firstVisibleIndex)-1;var u,c=n.paddings,f=c.forward,d=c.backward,p=0,h=0;for(u=r.finiteAbsMinIndex;u<t;u++)p+=r.getSizeByIndex(u);for(u=i+1;u<=r.finiteAbsMaxIndex;u++)h+=r.getSizeByIndex(u);var g=n.getScrollableSize()-f.size-d.size,m=n.getSize()-(p+g+h);m>0&&(o?p+=m:h+=m,e.logger.log((function(){return o?"backward":"forward padding will be increased by "+m+" to fill the viewport"}))),d.size=p,f.size=h,e.logger.stat("after paddings adjustments")},t.calculatePosition=function(e){var t=e.viewport,i=e.buffer,n=e.state,r=n.fetch,o=n.render,s=n.scrollState,a=t.paddings.backward.size;if(isNaN(r.firstVisibleIndex)||isNaN(i.firstIndex))r.isPrepend&&r.negativeSize&&(a+=r.negativeSize);else{for(var l=i.firstIndex;l<r.firstVisibleIndex;l++)a+=i.getSizeByIndex(l);r.firstVisibleItemDelta&&(a-=r.firstVisibleItemDelta)}if(null!==s.positionBeforeAsync){var u=o.positionBefore-s.positionBeforeAsync;0!==u&&(e.logger.log("shift position due to fetch-render difference ("+u+")"),a+=u)}return t.offset>0&&(a||r.positions.before)&&(a+=t.offset),Math.round(a)},t.setPosition=function(e,t,i){var n=e.state.scrollState,r=e.viewport;if(!n.hasPositionChanged(t))return i();n.syntheticPosition=t,n.syntheticFulfill=!1,n.animationFrameId=requestAnimationFrame((function(){var o=n.positionAfterAdjust-r.scrollPosition,s="";o>0&&(t-=o,n.syntheticPosition=t,s=" (-"+o+")"),n.syntheticFulfill=!0,r.scrollPosition=t,e.logger.stat("after scroll adjustment"+s),i()}))},t}(nt(le.adjust)),Nt=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return i(n,t),n.run=function(e){n.prepareClip(e),e.workflow.call({process:n.process,status:ce.next,payload:{doClip:e.state.clip.doClip}})},n.prepareClip=function(t){var i=t.state,r=i.fetch,o=i.clip;if(!n.shouldNotClip(t)){var s=r.first.indexBuffer,a=r.last.indexBuffer;t.logger.log((function(){return"looking for "+(r.direction?"anti-"+r.direction+" ":"")+"items that are out of ["+s+".."+a+"] range"})),n.isBackward(t,s)&&n.prepareClipByDirection(t,e.Direction.backward,s),n.isForward(t,a)&&n.prepareClipByDirection(t,e.Direction.forward,a),o.doClip||t.logger.log("skipping clip [no items to clip]")}},n.shouldNotClip=function(e){var t=e.settings,i=e.buffer,n=e.state;return t.infinite&&!n.clip.force?(e.logger.log("skipping clip [infinite mode]"),!0):i.size?!!n.cycle.isInitial&&(e.logger.log("skipping clip [initial cycle]"),!0):(e.logger.log("skipping clip [empty buffer]"),!0)},n.isBackward=function(t,i){var n=t.buffer,r=t.state,o=r.clip,s=r.fetch;return o.force?o.forceBackward:s.direction!==e.Direction.backward&&i-1>=n.absMinIndex},n.isForward=function(t,i){var n=t.buffer,r=t.state,o=r.clip,s=r.fetch;return o.force?o.forceForward:s.direction!==e.Direction.forward&&i+1<=n.absMaxIndex},n.prepareClipByDirection=function(t,i,n){var r=i===e.Direction.forward;t.buffer.items.forEach((function(e){(!r&&e.$index<n||r&&e.$index>n)&&(e.toRemove=!0,e.removeDirection=i,t.state.clip.doClip=!0)}))},n}(nt(le.preClip)),Et=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return i(n,t),n.run=function(e){var t=e.workflow;n.doClip(e),t.call({process:n.process,status:ce.next})},n.doClip=function(t){var i,n=t.buffer,r=t.viewport.paddings,o=t.state.clip,s=t.logger,a=((i={})[e.Direction.backward]=0,i[e.Direction.forward]=0,i);s.stat("before clip ("+ ++o.callCount+")");var l=n.items.filter((function(e){return!!e.toRemove&&(e.hide(),a[e.removeDirection]+=e.size,!0)}));l.length&&(a[e.Direction.backward]&&(r.byDirection(e.Direction.backward).size+=a[e.Direction.backward]),a[e.Direction.forward]&&(r.byDirection(e.Direction.forward).size+=a[e.Direction.forward]),t.settings.onBeforeClip&&t.settings.onBeforeClip(l.map((function(e){return e.get()})))),n.clip(),s.log((function(){var e=l.map((function(e){return e.$index}));return e.length?["clipped "+e.length+" item(s) from Buffer"+(a.backward?", +"+a.backward+" fwd px":"")+(a.forward?", +"+a.forward+" bwd px":"")+", range: ["+e[0]+".."+e[e.length-1]+"]"]:"clipped 0 items from Buffer"})),s.stat("after clip")},n}(nt(le.clip)),Ot=function(e){return!!e.call.interrupted},Mt=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return i(r,t),r.run=function(e,t){var i=(void 0===t?{}:t).error,o=e.workflow,s=e.state.cycle.interrupter;if(i||s||r.calculateParams(e,o),Ot(o))o.call({process:r.process,status:ce.done});else{var a=r.finalizeInnerLoop(e,i);o.call({process:r.process,status:a?ce.next:ce.done,payload:n({},s?{process:s}:{})})}},r.calculateParams=function(t,i){var n,r=t.adapter,o=t.viewport,s=t.buffer.items;r.wanted.firstVisible&&((n=o.getEdgeVisibleItem(s,e.Direction.backward).item)&&n.element===r.firstVisible.element||(r.firstVisible=n?n.get():y));r.wanted.lastVisible&&!Ot(i)&&((n=o.getEdgeVisibleItem(s,e.Direction.forward).item)&&n.element===r.lastVisible.element||(r.lastVisible=n?n.get():y))},r.finalizeInnerLoop=function(e,t){var i=e.state,n=e.state,o=n.cycle,s=n.clip,a=n.fetch,l=!!o.interrupter||!t&&r.getNext(e);return o.innerLoop.isInitial=!1,a.stopSimulate(),s.reset(!0),i.endInnerLoop(),l},r.getNext=function(e){var t=e.state,i=t.fetch,n=t.render;return!(!i.simulate||!i.isCheck||n.noSize)||(!(!i.simulate||!i.doRemove)||!(i.simulate||!(i.hasNewItems&&!n.noSize||i.hasAnotherPack)))},r}(nt(le.end)),Vt=function(){function e(e,t,i){var n=this;this.logs=[],this.logAdapterMethod=function(e,t,i){if(n.debug){var r=(void 0===t?[]:Array.isArray(t)?t:[t]).map((function(e){return"function"==typeof e?"func":"object"==typeof e&&e?Array.isArray(e)?"[of "+e.length+"]":"{ "+Object.keys(e).join(", ")+" }":e})).join(", ");n.log("adapter: "+e+"("+(r||"")+")"+(i||""))}};var r=e.settings;this.debug=r.debug,this.immediateLog=r.immediateLog,this.logTime=r.logTime,this.getTime=function(){return e.state&&" // time: "+e.state.time},this.getStat=function(){var t=e.buffer,i=e.viewport,n=t.getFirstVisibleItem(),r=t.getLastVisibleItem();return"pos: "+i.scrollPosition+", size: "+i.getScrollableSize()+", bwd_p: "+i.paddings.backward.size+", fwd_p: "+i.paddings.forward.size+", default: "+(t.defaultSize||"no")+", items: "+t.getVisibleItemsCount()+", range: "+(n&&r?"["+n.$index+".."+r.$index+"]":"no")},this.getFetchRange=function(){var t=e.state.fetch,i=t.first.index,n=t.last.index;return Number.isNaN(i)||Number.isNaN(n)?"no":"["+i+".."+n+"]"},this.getLoopId=function(){return e.state.cycle.loopId},this.getLoopIdNext=function(){return e.state.cycle.loopIdNext},this.getWorkflowCycleData=function(){return r.instanceIndex+"-"+e.state.cycle.count},this.getScrollPosition=function(t){return e.routines.getScrollPosition(t)},this.log((function(){return"vscroll Workflow has been started, core: "+t.core.name+" v"+t.core.version+", consumer: "+t.consumer.name+" v"+t.consumer.version+", workflow instance: "+r.instanceIndex+", adapter "+(i?"instance: "+i.id:"is not instantiated")}))}return e.prototype.object=function(e,t,i){this.log((function(){return[e,i?JSON.stringify(t,(function(e,t){return Number.isNaN(t)?"NaN":t===1/0?"Infinity":t===-1/0?"-Infinity":t instanceof Element?"HTMLElement":t instanceof HTMLDocument?"HTMLDocument":"function"==typeof t?"Function":t})).replace(/"/g,"").replace(/(\{|:|,)/g,"$1 ").replace(/(\})/g," $1"):t]}))},e.prototype.stat=function(e){var t=this;if(this.debug){var i=["color: #888; border: dashed #888 0; border-bottom-width: 0px","color: #000; border-width: 0"];this.log((function(){return s(["%cstat"+(e?" "+e:"")+",%c "+t.getStat()],o(i))}))}},e.prototype.fetch=function(e){var t=this;if(this.debug){var i="fetch interval"+(e?" "+e:""),n=["color: #888","color: #000"];this.log((function(){return s(["%c"+i+": %c"+t.getFetchRange()],o(n))}))}},e.prototype.prepareForLog=function(e){return e instanceof Event&&e.target?this.getScrollPosition(e.target):e},e.prototype.logProcess=function(e){if(this.debug){var t=e.process,i=e.status,n=e.payload,r=[];if(t===le.init&&i===ce.next)r.push("%c---=== loop "+this.getLoopIdNext()+" start");else if(t===le.end){r.push("%c---=== loop "+this.getLoopId()+" done");var a=n&&n.process;i===ce.next&&a!==ue.reset&&a!==ue.reload&&(r[0]+=", loop "+this.getLoopIdNext()+" start")}r.length&&this.log((function(){return s(s([],o(r)),["color: #006600;"])}))}},e.prototype.logCycle=function(e){void 0===e&&(e=!0);var t=this.getWorkflowCycleData(),i="color: #0000aa; border: solid #555 1px; border-width: "+(e?"1px 0 0 1px":"0 0 1px 1px")+"; margin-left: -2px";this.log((function(){return["%c   ~~~ WF Cycle "+t+" "+(e?"STARTED":"FINALIZED")+" ~~~  ",i]}))},e.prototype.logError=function(e){var t=this;if(this.debug){var i=["color: #a00;","color: #000"];this.log((function(){return s(["error:%c"+(e?" "+e:"")+"%c (loop "+t.getLoopIdNext()+")"],o(i))}))}},e.prototype.log=function(){for(var e=this,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];if(this.debug){if("function"==typeof t[0]&&(t=t[0](),Array.isArray(t)||(t=[t])),t.every((function(e){return void 0===e})))return;this.logTime&&(t=s(s([],o(t)),[this.getTime()])),t=t.map((function(t){return e.prepareForLog(t)})),this.immediateLog?console.log.apply(this,t):this.logs.push(t)}},e.prototype.logForce=function(){for(var e=this,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];this.debug&&(!this.immediateLog&&this.logs.length&&(this.logs.forEach((function(t){return console.log.apply(e,t)})),this.logs=[]),t.length&&console.log.apply(this,t))},e}(),Pt=function(){function t(e){this.horizontal=e.horizontal,this.window=e.windowViewport}return t.prototype.checkElement=function(e){if(!e)throw new Error("HTML element is not defined")},t.prototype.getScrollPosition=function(e){return this.window?window.pageYOffset:(this.checkElement(e),e[this.horizontal?"scrollLeft":"scrollTop"])},t.prototype.setScrollPosition=function(e,t){t=Math.max(0,t),this.window?this.horizontal?window.scrollTo(t,window.scrollY):window.scrollTo(window.scrollX,t):(this.checkElement(e),e[this.horizontal?"scrollLeft":"scrollTop"]=t)},t.prototype.getParams=function(e,t){return this.checkElement(e),this.window&&t?{height:e.clientHeight,width:e.clientWidth,top:e.clientTop,bottom:e.clientTop+e.clientHeight,left:e.clientLeft,right:e.clientLeft+e.clientWidth}:e.getBoundingClientRect()},t.prototype.getSize=function(e,t){return this.getParams(e,t)[this.horizontal?"width":"height"]},t.prototype.getSizeStyle=function(e){this.checkElement(e);var t=e.style[this.horizontal?"width":"height"];return parseFloat(t)||0},t.prototype.setSizeStyle=function(e,t){this.checkElement(e),t=Math.max(0,Math.round(t)),e.style[this.horizontal?"width":"height"]=t+"px"},t.prototype.getEdge=function(t,i,n){return this.getParams(t,n)[i===e.Direction.forward?this.horizontal?"right":"bottom":this.horizontal?"left":"top"]},t.prototype.getEdge2=function(t,i,n,r){return t.offsetTop-(n?n.scrollTop:0)+(i===(r?e.Direction.backward:e.Direction.forward)?this.getSize(t):0)},t.prototype.hideElement=function(e){this.checkElement(e),e.style.display="none"},t.prototype.getOffset=function(e){return this.checkElement(e),(this.horizontal?e.offsetLeft:e.offsetTop)||0},t.prototype.scrollTo=function(e,t){this.checkElement(e),e.scrollIntoView(t)},t}(),At=function(){function e(e,t,i){this.element=e.querySelector("[data-padding-"+t+"]"),this.direction=t,this.routines=i}return e.prototype.reset=function(e){this.size=e||0},Object.defineProperty(e.prototype,"size",{get:function(){return this.routines.getSizeStyle(this.element)},set:function(e){this.routines.setSizeStyle(this.element,e)},enumerable:!1,configurable:!0}),e}(),Dt=function(){function t(t,i,n){this.settings=n,this.forward=new At(t,e.Direction.forward,i),this.backward=new At(t,e.Direction.backward,i)}return t.prototype.byDirection=function(t,i){return t===e.Direction.backward?i?this.forward:this.backward:i?this.backward:this.forward},t.prototype.reset=function(e,t,i){var n,r=this.getPositiveSize(t,e,i),o=this.getNegativeSize(t);this.settings.inverse?(this.forward.reset(o),this.backward.reset(r),(n=e-this.backward.size-i)>0&&(this.backward.size+=n,this.forward.size-=n)):(this.forward.reset(r),this.backward.reset(o),(n=e-this.forward.size-i)>0&&(this.backward.size-=n,this.forward.size+=n))},t.prototype.getPositiveSize=function(e,t,i){var n=this.settings,r=t;return isFinite(n.maxIndex)&&(r=(n.maxIndex-e+1)*n.itemSize),i&&(r=Math.max(r-i,0)),r},t.prototype.getNegativeSize=function(e){var t=this.settings,i=0;return isFinite(t.minIndex)&&(i=(e-t.minIndex)*t.itemSize),i},t}(),$t=function(){function t(e,t,i,n,r){this.element=e,this.settings=t,this.routines=i,this.state=n,this.logger=r,this.disabled=!1,t.windowViewport?(this.hostElement=document.documentElement,this.scrollEventReceiver=window):(this.hostElement=t.viewport||this.element.parentElement,this.scrollEventReceiver=this.hostElement),this.paddings=new Dt(this.element,this.routines,t),t.windowViewport&&"scrollRestoration"in history&&(history.scrollRestoration="manual"),t.dismissOverflowAnchor&&(this.hostElement.style.overflowAnchor="none")}return t.prototype.reset=function(e){this.setOffset(),this.paddings.reset(this.getSize(),e,this.offset),this.scrollPosition=this.paddings.backward.size||0,this.state.scrollState.reset()},t.prototype.setPosition=function(e){if(this.scrollPosition===e)return this.logger.log((function(){return["setting scroll position at",e,"[cancelled]"]})),e;this.routines.setScrollPosition(this.hostElement,e);var t=this.scrollPosition;return this.logger.log((function(){return s(["setting scroll position at",t],o(t!==e?["("+e+")"]:[]))})),t},Object.defineProperty(t.prototype,"scrollPosition",{get:function(){return this.routines.getScrollPosition(this.hostElement)},set:function(e){this.setPosition(e)},enumerable:!1,configurable:!0}),t.prototype.disableScrollForOneLoop=function(){var e=this;if(!this.disabled){var t=this.hostElement.style;if("hidden"!==t.overflowY){this.disabled=!0;var i=t.overflowY;setTimeout((function(){e.disabled=!1,t.overflowY=i})),t.overflowY="hidden"}}},t.prototype.getSize=function(){return this.routines.getSize(this.hostElement,!0)},t.prototype.getScrollableSize=function(){return this.routines.getSize(this.element)},t.prototype.getBufferPadding=function(){return this.getSize()*this.settings.padding},t.prototype.getEdge=function(e){return this.routines.getEdge(this.hostElement,e,!0)},t.prototype.setOffset=function(){this.offset=this.routines.getOffset(this.element),this.settings.windowViewport||(this.offset-=this.routines.getOffset(this.hostElement))},t.prototype.getEdgeVisibleItem=function(t,i){for(var n,r=i===e.Direction.backward,o=r?e.Direction.forward:e.Direction.backward,s=this.getEdge(i),a=0,l=r?0:t.length-1;r?l<=t.length-1:l>=0;l+=r?1:-1){if(a=this.routines.getEdge(t[l].element,o)-s,r&&a>0||!r&&a<0){n=t[l];break}}return{item:n,index:n?n.$index:NaN,diff:a}},t}(),Tt=function(){function e(){this.reset()}return e.prototype.reset=function(){this.newItems=[],this.oldItems=[],this.removed=[]},e}(),Rt=function(){function t(e,t){this.itemSize=e,this.sizeStrategy=t,this.sizeMap=new Map,this.recalculation=new Tt}return t.prototype.reset=function(e){e&&(this.constantSize=this.itemSize,this.frequentSize=this.itemSize,this.averageSize=this.itemSize,this.averageSizeFloat=this.itemSize,this.sizeMap.clear()),this.recalculation.reset()},t.prototype.get=function(){switch(this.sizeStrategy){case e.SizeStrategy.Average:return this.averageSize;case e.SizeStrategy.Frequent:return this.frequentSize;default:return this.constantSize}},t.prototype.recalculateAverageSize=function(e){var t=this.recalculation,i=t.oldItems,n=t.newItems,r=t.removed;if(i.length){var o=i.reduce((function(e,t){return e+t.size}),0),s=i.reduce((function(e,t){return e+t.newSize}),0),a=this.averageSizeFloat||0;this.averageSizeFloat=a-(o-s)/(e-n.length)}if(n.length){s=n.reduce((function(e,t){return e+t.size}),0),a=this.averageSizeFloat||0;this.averageSizeFloat=((e-n.length)*a+s)/e}if(r.length){var l=r.reduce((function(e,t){return e+t.size}),0);a=this.averageSizeFloat||0;this.averageSizeFloat=((e+r.length)*a-l)/e}this.averageSize=Math.round(this.averageSizeFloat)},t.prototype.recalculateFrequentSize=function(){var e=this,t=this.recalculation,i=t.oldItems,n=t.newItems,r=t.removed,a=this.sizeMap.get(this.frequentSize);n.length&&n.forEach((function(t){var i=t.size;return e.sizeMap.set(i,(e.sizeMap.get(i)||0)+1)})),i.length&&(i.forEach((function(t){var i=t.size;return e.sizeMap.set(i,Math.max((e.sizeMap.get(i)||0)-1,0))})),i.forEach((function(t){var i=t.newSize;return e.sizeMap.set(i,(e.sizeMap.get(i)||0)+1)}))),r.length&&r.forEach((function(t){var i=t.size;return e.sizeMap.set(i,Math.max((e.sizeMap.get(i)||0)-1,0))}));var l=s([],o(this.sizeMap.entries())).sort((function(e,t){return t[1]-e[1]})),u=l[0][1],c=l.filter((function(e){return e[1]===u}));c.length>1&&c.find((function(e){return e[0]===a}))||(this.frequentSize=l[0][0])},t.prototype.recalculate=function(t){if(this.sizeStrategy===e.SizeStrategy.Constant)return!1;var i=this.recalculation,n=i.oldItems,r=i.newItems,o=i.removed;if(!n.length&&!r.length&&!o.length)return!1;var s=this.get();return this.sizeStrategy===e.SizeStrategy.Average?this.recalculateAverageSize(t):this.recalculateFrequentSize(),this.recalculation.reset(),this.get()!==s},t.prototype.setExisted=function(t,i){this.sizeStrategy!==e.SizeStrategy.Constant&&this.recalculation.oldItems.push({size:t.size,newSize:i.size})},t.prototype.setNew=function(t){this.sizeStrategy!==e.SizeStrategy.Constant?this.recalculation.newItems.push({size:t.size}):this.constantSize||(this.constantSize=t.size)},t.prototype.setRemoved=function(t){this.sizeStrategy!==e.SizeStrategy.Constant&&this.recalculation.removed.push({size:t.size})},t}(),jt=function(){function e(e,t){this.$index=e.$index,this.nodeId=e.nodeId,this.data=t?e.data:null,this.size=e.size}return e.prototype.changeIndex=function(e){this.$index=e,this.nodeId=String(e)},e}(),Ft=function(){function e(e,t){var i=e.itemSize,n=e.cacheData,r=e.cacheOnReload,o=e.sizeStrategy;this.itemSize=i,this.saveData=n,this.cacheOnReload=r,this.sizeStrategy=o,this.logger=t,this.items=new Map,this.defaultSize=new Rt(i,o),this.reset(!0)}return e.prototype.reset=function(e){(e=e||!this.cacheOnReload)&&(this.minIndex=1/0,this.maxIndex=-1/0,this.items.clear()),this.defaultSize.reset(e)},Object.defineProperty(e.prototype,"size",{get:function(){return this.items.size},enumerable:!1,configurable:!0}),e.prototype.get=function(e){return this.items.get(e)},e.prototype.getItemSize=function(e){var t=this.get(e);return t?t.size:0},e.prototype.getDefaultSize=function(){return this.defaultSize.get()},e.prototype.recalculateDefaultSize=function(){var e=this;return!!this.defaultSize.recalculate(this.size)&&(this.logger.log((function(){return"default size has been updated: "+e.defaultSize.get()})),!0)},e.prototype.add=function(e){var t=this.get(e.$index);return t?(this.saveData&&(t.data=e.data),t.size!==e.size&&(void 0!==t.size?this.defaultSize.setExisted(t,e):this.defaultSize.setNew(e),t.size=e.size)):(t=new jt(e,this.saveData),this.items.set(e.$index,t),this.defaultSize.setNew(t)),e.$index<this.minIndex&&(this.minIndex=e.$index),e.$index>this.maxIndex&&(this.maxIndex=e.$index),t},e.prototype.removeItems=function(e,t){var i=this,n=new Map,r=1/0,o=-1/0;this.items.forEach((function(s){if(e.some((function(e){return e===s.$index})))void 0!==s.size&&i.defaultSize.setRemoved(s);else{var a=t?e.reduce((function(e,t){return e+(s.$index<t?1:0)}),0):e.reduce((function(e,t){return e-(s.$index>t?1:0)}),0);s.changeIndex(s.$index+a),n.set(s.$index,s),r=s.$index<r?s.$index:r,o=s.$index>o?s.$index:o}})),this.items=n,this.minIndex=r,this.maxIndex=o},e.prototype.updateSubset=function(e,t,i){var n=this;if(this.size&&e.length){var r,o,s,a=e[0],l=e[e.length-1];if(t.length){var u=t[0].$index,c=t[t.length-1].$index;r=u-a,o=c-l}else r=i?l-a+1:0,o=i?0:a-l-1;var f=new Map;this.items.forEach((function(e){return e.$index<a?(e.changeIndex(e.$index+r),void f.set(e.$index,e)):e.$index>l?(e.changeIndex(e.$index+o),void f.set(e.$index,e)):void 0})),t.forEach((function(e){return f.set(e.$index,new jt(e,n.saveData))})),e.forEach((function(e){!t.some((function(t){var i=t.$index;return e===i}))&&(s=n.get(e))&&n.defaultSize.setRemoved(s)})),this.minIndex+=r,this.maxIndex+=o,this.items=f}},e}(),Ct=function(){function t(e,t,i){this._items=[],this.logger=i,this.changeItems=t,this.bof=new u(!1),this.eof=new u(!1),this.cache=new Ft(e,i),this.startIndexUser=e.startIndex,this.minIndexUser=e.minIndex,this.maxIndexUser=e.maxIndex,this.reset(!0)}return t.prototype.dispose=function(){this.bof.dispose(),this.eof.dispose(),this._items.forEach((function(e){return e.dispose()})),this._items=[]},t.prototype.reset=function(e,t){this.items.forEach((function(e){return e.hide()})),this.pristine=!0,this.items=[],this.cache.reset(e),this.absMinIndex=this.minIndexUser,this.absMaxIndex=this.maxIndexUser,this.setCurrentStartIndex(t),this.bof.set(!1),this.eof.set(!1),this.pristine=!1},t.prototype.setCurrentStartIndex=function(e){var t=this.minIndexUser,i=this.maxIndexUser,n=this.startIndexUser,r=Number(e);Number.isNaN(r)&&(this.logger.log((function(){return"fallback startIndex to settings.startIndex ("+n+")"})),r=n),r<t&&(this.logger.log((function(){return"setting startIndex to settings.minIndex ("+t+") because "+r+" < "+t})),r=t),r>i&&(this.logger.log((function(){return"setting startIndex to settings.maxIndex ("+i+") because "+r+" > "+i})),r=i),this.startIndex=r},Object.defineProperty(t.prototype,"items",{get:function(){return this._items},set:function(e){this._items=e,this.changeItems(e),this.pristine||(this.checkBOF(),this.checkEOF())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"absMinIndex",{get:function(){return this._absMinIndex},set:function(e){this._absMinIndex!==e&&(this._absMinIndex=Number.isFinite(this._absMaxIndex)&&e>this._absMaxIndex?this._absMaxIndex:e),this.pristine||this.checkBOF()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"absMaxIndex",{get:function(){return this._absMaxIndex},set:function(e){this._absMaxIndex!==e&&(this._absMaxIndex=Number.isFinite(this._absMinIndex)&&e<this._absMinIndex?this._absMinIndex:e),this.pristine||this.checkEOF()},enumerable:!1,configurable:!0}),t.prototype.checkBOF=function(){var e=this.items.length?this.items[0].$index===this.absMinIndex:isFinite(this.absMinIndex);this.bof.set(e)},t.prototype.checkEOF=function(){var e=this.items.length?this.items[this.items.length-1].$index===this.absMaxIndex:isFinite(this.absMaxIndex);this.eof.set(e)},Object.defineProperty(t.prototype,"size",{get:function(){return this._items.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cacheSize",{get:function(){return this.cache.size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"defaultSize",{get:function(){return this.cache.getDefaultSize()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"minIndex",{get:function(){return isFinite(this.cache.minIndex)?this.cache.minIndex:this.startIndex},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maxIndex",{get:function(){return isFinite(this.cache.maxIndex)?this.cache.maxIndex:this.startIndex},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"firstIndex",{get:function(){return this.items.length?this.items[0].$index:NaN},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lastIndex",{get:function(){return this.items.length?this.items[this.items.length-1].$index:NaN},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"finiteAbsMinIndex",{get:function(){return isFinite(this.absMinIndex)?this.absMinIndex:this.minIndex},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"finiteAbsMaxIndex",{get:function(){return isFinite(this.absMaxIndex)?this.absMaxIndex:this.maxIndex},enumerable:!1,configurable:!0}),t.prototype.get=function(e){return this.items.find((function(t){return t.$index===e}))},t.prototype.setItems=function(e){if(this.items.length)if(this.items[0].$index>e[e.length-1].$index)this.items=s(s([],o(e)),o(this.items));else{if(!(e[0].$index>this.items[this.items.length-1].$index))return!1;this.items=s(s([],o(this.items)),o(e))}else this.items=s([],o(e));return!0},t.prototype.clip=function(){this.items=this.items.filter((function(e){return!e.toRemove}))},t.prototype.append=function(e){this.items=s(s([],o(this.items)),o(e))},t.prototype.prepend=function(e){this.items=s(s([],o(e)),o(this.items))},t.prototype.shiftExtremum=function(e,t){t?(this.absMinIndex-=e,this.startIndex-=e):this.absMaxIndex+=e,this.startIndex>this.absMaxIndex?this.startIndex=this.absMaxIndex:this.startIndex<this.absMinIndex&&(this.startIndex=this.absMinIndex)},t.prototype.removeItems=function(e,t,i){void 0===i&&(i=!1);for(var n=[],r=i?e:[],a=this.items.length,l=!1,u=function(o){var s=c.items[o];if(!i&&e.indexOf(s.$index)>=0)return r.push(s.$index),"continue";var a=r.reduce((function(e,i){return e+(t?s.$index<i?1:0:s.$index>i?-1:0)}),0);l=l||!!a,s.updateIndex(s.$index+a),i||(t?n.unshift(s):n.push(s))},c=this,f=t?a-1:0;t?f>=0:f<a;t?f--:f++)u(f);this.shiftExtremum(-r.length,t),i?l&&(this.items=s([],o(this.items))):this.items=n,this.cache.removeItems(r,t)},t.prototype.updateItems=function(e,t,i,n){var r=this;if(!this.size||Number.isNaN(this.firstIndex))return NaN;var a=i,l=n?this.lastIndex:this.firstIndex,u=[],c=n?-1:1,f=this.items.map((function(e){return e.$index}));return(n?this.items.reverse():this.items).forEach((function(f){var d=e(f);if(!d||Array.isArray(d)&&!d.length)return f.toRemove=!0,a+=f.$index>=i?n?1:0:n?0:-1,void r.shiftExtremum(-1,n);if(!Array.isArray(d))return f.updateIndex(l),u.push(f),void(l+=c);f.$index<i?a+=n?0:d.length-1:f.$index>i&&(a+=n?1-d.length:0);var p=!0,h=[];(n?s([],o(d)).reverse():d).forEach((function(e,n){var r;f.data===e?(i===f.$index&&(a=l+n*c),f.updateIndex(l+n*c),r=f,p=!1):(r=t(l+n*c,e)).toInsert=!0,h.push(r)})),f.toRemove=p,u.push.apply(u,s([],o(h))),l+=c*d.length,d.length>1&&r.shiftExtremum(d.length-1,n)})),this.items=n?u.reverse():u,this.cache.updateSubset(f,this.items,n),this.finiteAbsMinIndex===this.finiteAbsMaxIndex?a=NaN:a>this.finiteAbsMaxIndex?a=this.finiteAbsMaxIndex:a<this.finiteAbsMinIndex&&(a=this.finiteAbsMinIndex),a},t.prototype.cacheItem=function(e){this.cache.add(e)},t.prototype.getFirstVisibleItemIndex=function(){for(var e=this.items.length,t=0;t<e;t++)if(!this.items[t].invisible)return t;return-1},t.prototype.getLastVisibleItemIndex=function(){for(var e=this.items.length-1;e>=0;e--)if(!this.items[e].invisible)return e;return-1},t.prototype.getFirstVisibleItem=function(){var e=this.getFirstVisibleItemIndex();if(e>=0)return this.items[e]},t.prototype.getLastVisibleItem=function(){var e=this.getLastVisibleItemIndex();if(e>=0)return this.items[e]},t.prototype.getEdgeVisibleItem=function(t,i){return t===(i?e.Direction.backward:e.Direction.forward)?this.getLastVisibleItem():this.getFirstVisibleItem()},t.prototype.getVisibleItemsCount=function(){return this.items.reduce((function(e,t){return e+(t.invisible?0:1)}),0)},t.prototype.getSizeByIndex=function(e){var t=this.cache.get(e);return t?t.size:this.defaultSize},t.prototype.checkDefaultSize=function(){return this.cache.recalculateDefaultSize()},t.prototype.getIndexToAppend=function(e){return(e?this.absMaxIndex:this.size?this.items[this.size-1].$index:this.maxIndex)+(this.size?1:0)},t.prototype.getIndexToPrepend=function(e){return(e?this.absMinIndex:this.size?this.items[0].$index:this.minIndex)-(this.size?1:0)},t.prototype.getIndexToAdd=function(e,t){return t?this.getIndexToPrepend(e):this.getIndexToAppend(e)},t}(),Lt=function(){function e(e){this.total=e,this.isInitial=!1,this.busy=new u(!1)}return Object.defineProperty(e.prototype,"first",{get:function(){return 0===this.count},enumerable:!1,configurable:!0}),e.prototype.done=function(){this.count++,this.total++,this.busy.set(!1)},e.prototype.start=function(){this.busy.set(!0)},e.prototype.dispose=function(){this.busy.dispose()},e}(),Bt=function(){function e(e,t){var i=t?t.count:1,n=t?t.innerLoop.count:0;this.instanceIndex=e,this.innerLoop=new Lt(n),this.interrupter=null,this.busy=new u(!1),this.done(i)}return Object.defineProperty(e.prototype,"loopId",{get:function(){return this.instanceIndex+"-"+this.count+"-"+this.innerLoop.total},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loopIdNext",{get:function(){return this.instanceIndex+"-"+this.count+"-"+(this.innerLoop.total+1)},enumerable:!1,configurable:!0}),e.prototype.done=function(e){this.count=e,this.isInitial=!1,this.busy.set(!1)},e.prototype.start=function(e,t){this.isInitial=e,this.initiator=t,this.innerLoop.isInitial=e,this.innerLoop.count=0,this.interrupter=null,this.busy.set(!0)},e.prototype.dispose=function(e){e&&this.busy.dispose(),this.innerLoop.dispose()},e}(),_t=function(){function e(){this.reset()}return e.prototype.reset=function(){this.startDelta=0,this.before=0},e}(),Ut=function(){function e(){this.reset()}return e.prototype.reset=function(){this.index=NaN,this.indexBuffer=NaN,this.position=NaN},e}(),Wt=function(){function e(){this.reset()}return e.prototype.reset=function(){this.index=NaN,this.indexBuffer=NaN},e}(),qt=function(){function t(){this.callCount=0,this.positions=new _t,this.first=new Ut,this.last=new Wt,this.reset()}return t.prototype.reset=function(){this._newItemsData=null,this.items=[],this.positions.reset(),this.first.reset(),this.last.reset(),this.hasAnotherPack=!1,this.firstVisibleIndex=NaN,this.firstVisibleItemDelta=NaN,this.negativeSize=0,this.direction=null,this.cancel=null,this.simulate=!1,this.isPrepend=!1,this.isCheck=!1,this.doRemove=!1},Object.defineProperty(t.prototype,"newItemsData",{get:function(){return this._newItemsData},set:function(e){this._newItemsData=e,e&&e.length&&this.callCount++},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"shouldFetch",{get:function(){return!!this.count},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasNewItems",{get:function(){return!(!this._newItemsData||!this._newItemsData.length)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"index",{get:function(){return this.first.index},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"count",{get:function(){return isNaN(this.first.index)||isNaN(this.last.index)?0:this.last.index-this.first.index+1},enumerable:!1,configurable:!0}),t.prototype.startSimulate=function(e){this.simulate=!0,this._newItemsData=e.map((function(e){return e.data})),this.items=e,this.hasAnotherPack=!1,this.negativeSize=0},t.prototype.stopSimulate=function(){this.simulate=!1,this.isPrepend=!1,this.isCheck=!1,this.doRemove=!1},t.prototype.append=function(t){this.startSimulate(t),this.last.index=t[t.length-1].$index,this.first.index=t[0].$index,this.direction=e.Direction.forward},t.prototype.prepend=function(t){this.startSimulate(t),this.last.index=t[0].$index,this.first.index=t[t.length-1].$index,this.direction=e.Direction.backward,this.isPrepend=!0},t.prototype.check=function(e){this.startSimulate(e),this.last.index=e[0].$index,this.first.index=e[e.length-1].$index,this.isCheck=!0},t.prototype.remove=function(){this.startSimulate([]),this.doRemove=!0},t.prototype.update=function(e,t,i,n){this.startSimulate(i),this.firstVisibleIndex=e,this.firstVisibleItemDelta=t,this.doRemove=n.length>0},t}(),Ht=function(){function e(){this.callCount=0,this.reset()}return Object.defineProperty(e.prototype,"force",{get:function(){return this.forceForward||this.forceBackward},enumerable:!1,configurable:!0}),e.prototype.reset=function(e){this.doClip=!1,e||(this.forceForward=!1,this.forceBackward=!1)},e}(),Gt=function(){function e(){this.reset()}return Object.defineProperty(e.prototype,"noSize",{get:function(){return this.sizeBefore===this.sizeAfter},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this.sizeBefore=0,this.sizeAfter=0,this.positionBefore=0,this.renderTimer=null},e}(),Xt=function(){function e(){this.reset()}return e.prototype.reset=function(){this.previous=null,this.current=null,this.syntheticPosition=null,this.syntheticFulfill=!1,this.positionBeforeAsync=null,this.positionBeforeAdjust=null,this.positionAfterAdjust=null,this.cleanupTimers()},e.prototype.cleanupTimers=function(){this.scrollTimer&&(clearTimeout(this.scrollTimer),this.scrollTimer=null),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0)},e.prototype.hasPositionChanged=function(e){var t=this.positionBeforeAdjust,i=this.positionAfterAdjust;return null===t||t!==e||null===i||i!==e},e}(),Yt=function(){function e(e,t,i){this.packageInfo=e,this.settings=t,this.initTime=Number(new Date),this.cycle=new Bt(this.settings.instanceIndex,i?i.cycle:void 0),this.fetch=new qt,this.clip=new Ht,this.render=new Gt,this.scrollState=new Xt}return Object.defineProperty(e.prototype,"time",{get:function(){return Number(new Date)-this.initTime},enumerable:!1,configurable:!0}),e.prototype.endInnerLoop=function(){var e=this,t=e.fetch,i=e.render,n=e.cycle;t.cancel&&(t.cancel(),t.cancel=null),i.renderTimer&&(clearTimeout(i.renderTimer),i.renderTimer=null),n.innerLoop.done()},e.prototype.startInnerLoop=function(){var e=this,t=e.cycle,i=e.scrollState,r=e.fetch,o=e.render,s=e.clip;return t.innerLoop.start(),i.positionBeforeAsync=null,r.simulate||r.reset(),s.reset(s.force),o.reset(),n({},t.innerLoop.first?{process:t.initiator,doRender:r.simulate&&r.items.length>0}:{})},e.prototype.dispose=function(){this.cycle.dispose(),this.endInnerLoop(),this.scrollState.cleanupTimers()},e}(),Jt=I(),Qt=function(e,t){return"object"==typeof e&&null!==e&&Object.prototype.hasOwnProperty.call(e,t)},Zt=function(e,t,i){var n=t;if(!Qt(t,"items")){var r=Array.isArray(t)?t:[t];n=e?{items:r,bof:i}:{items:r,eof:i}}return n},Kt=function(){function t(t,i,r){var s=this;this.source={},this.box={},this.demand={},this.wanted={},this.getWorkflow=i,this.logger=r,this.relax$=null,this.relaxRun=null,this.reloadCounter=0;var a=t&&w.get(t.id)||{},u=t?Jt.map((function(e){var i=t[e.name];if(t.augmented){var r=a[e.name];r&&(i=r.default)}return n(n({},e),{value:i})})):I();Object.entries(a).forEach((function(e){var t=o(e,2),i=t[0],n=t[1],r=u.find((function(e){return e.name===i}));r&&n&&(r.value=n.default)})),u.filter((function(e){var t=e.type,i=e.permanent;return t===l.Scalar&&i})).forEach((function(e){var t=e.name,i=e.value;return Object.defineProperty(s,t,{configurable:!0,get:function(){return i}})})),u.filter((function(e){return e.type===l.Reactive})).forEach((function(e){var t=e.name,i=e.value;s.source[t]=i,Object.defineProperty(s,t,{configurable:!0,get:function(){var e=Jt.find((function(e){var i=e.wanted,n=e.reactive;return i&&n===t}));return e&&(s.wanted[e.name]=!0),s.source[t]}})})),u.filter((function(e){return e.type===l.Scalar&&!!e.reactive})).forEach((function(e){var t=e.name,i=e.value,n=e.reactive,r=e.wanted;r&&(s.wanted[t]=!1),s.box[t]=i,Object.defineProperty(s,t,{configurable:!0,set:function(e){if(e!==s.box[t]){s.box[t]=e,s.source[n].set(e);var i=a[n];i&&i.emit(i.source,e)}},get:function(){return r&&(s.wanted[t]=!0),s.box[t]}})})),u.filter((function(e){return e.type===l.Scalar&&e.onDemand})).forEach((function(e){var t=e.name,i=e.value;s.demand[t]=i,Object.defineProperty(s,t,{configurable:!0,get:function(){return s.demand[t]}})})),t&&(u.forEach((function(i){var n=i.name,r=i.type,o=i.value,u=i.permanent,c=s[n];r===l.Function?c=c.bind(s):r===l.WorkflowRunner?c=s.getPromisifiedMethod(c,o):r===l.Reactive&&a[n]?c=t[n]:n===e.AdapterPropName.augmented&&(c=!0),Object.defineProperty(t,n,{configurable:!0,get:function(){return u||r!==l.Scalar?c:s[n]}})})),this.externalContext=t)}return Object.defineProperty(t.prototype,"workflow",{get:function(){return this.getWorkflow()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reloadCount",{get:function(){return this.reloadCounter},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reloadId",{get:function(){return this.id+"."+this.reloadCounter},enumerable:!1,configurable:!0}),t.prototype.getPromisifiedMethod=function(e,t){var i=this;return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return i.relax$?new Promise((function(t){i.relax$&&i.relax$.once((function(e){return t(e)})),e.apply(i,n)})):t.apply(i,n)}},t.prototype.initialize=function(t,i,n,r){var o=this;if(Object.defineProperty(this.demand,e.AdapterPropName.itemsCount,{get:function(){return t.getVisibleItemsCount()}}),Object.defineProperty(this.demand,e.AdapterPropName.bufferInfo,{get:function(){return{firstIndex:t.firstIndex,lastIndex:t.lastIndex,minIndex:t.minIndex,maxIndex:t.maxIndex,absMinIndex:t.absMinIndex,absMaxIndex:t.absMaxIndex,defaultSize:t.defaultSize}}}),this.bof=t.bof.get(),t.bof.on((function(e){return o.bof=e})),this.eof=t.eof.get(),t.eof.on((function(e){return o.eof=e})),Object.defineProperty(this.demand,e.AdapterPropName.packageInfo,{get:function(){return i.packageInfo}}),this.loopPending=i.cycle.innerLoop.busy.get(),i.cycle.innerLoop.busy.on((function(e){return o.loopPending=e})),this.isLoading=i.cycle.busy.get(),i.cycle.busy.on((function(e){return o.isLoading=e})),this.logger=n,r){this.relax$||(this.relax$=new u);var s=this.relax$;r.on((function(e){var t=e.status,i=e.payload,n=function(){};t===ce.start?n=o.isLoading$.on((function(e){e||(n(),s.set({success:!0,immediate:!1,details:null}))})):t!==ce.done&&t!==ce.error||(n(),s.set({success:t!==ce.error,immediate:!0,details:t===ce.error&&i?String(i.error):null}))}))}this.init=!0},t.prototype.dispose=function(){var e=this;this.relax$&&this.relax$.dispose(),this.externalContext&&this.resetContext(),Object.getOwnPropertyNames(this).forEach((function(t){delete e[t]}))},t.prototype.resetContext=function(){var e=this,t=w.get(this.externalContext.id);Jt.forEach((function(i){var n=i.type,r=i.permanent,o=i.name,s=i.value;if(n===l.Reactive||r||Object.defineProperty(e.externalContext,o,{configurable:!0,get:function(){return s}}),n===l.Reactive&&t){var a=t[o];a&&(a.default.reset(),a.emit(a.source,a.default.get()))}}))},t.prototype.reset=function(e){this.reloadCounter++,this.logger.logAdapterMethod("reset",e," of "+this.reloadId),this.workflow.call({process:ue.reset,status:ce.start,payload:{options:e}})},t.prototype.reload=function(e){this.reloadCounter++,this.logger.logAdapterMethod("reload",e," of "+this.reloadId),this.workflow.call({process:ue.reload,status:ce.start,payload:{options:e}})},t.prototype.append=function(e,t){var i=Zt(!1,e,t);this.logger.logAdapterMethod("append",[i.items,i.eof]),this.workflow.call({process:ue.append,status:ce.start,payload:{options:i}})},t.prototype.prepend=function(e,t){var i=Zt(!0,e,t);this.logger.logAdapterMethod("prepend",[i.items,i.bof]),this.workflow.call({process:ue.prepend,status:ce.start,payload:{options:i}})},t.prototype.check=function(){this.logger.logAdapterMethod("check"),this.workflow.call({process:ue.check,status:ce.start})},t.prototype.remove=function(e){e=function(e){return Qt(e,"predicate")||Qt(e,"indexes")||(e={predicate:e}),e}(e),this.logger.logAdapterMethod("remove",e),this.workflow.call({process:ue.remove,status:ce.start,payload:{options:e}})},t.prototype.clip=function(e){this.logger.logAdapterMethod("clip",e),this.workflow.call({process:ue.clip,status:ce.start,payload:{options:e}})},t.prototype.insert=function(e){this.logger.logAdapterMethod("insert",e),this.workflow.call({process:ue.insert,status:ce.start,payload:{options:e}})},t.prototype.replace=function(e){this.logger.logAdapterMethod("replace",e),this.workflow.call({process:ue.replace,status:ce.start,payload:{options:e}})},t.prototype.update=function(e){this.logger.logAdapterMethod("update",e),this.workflow.call({process:ue.update,status:ce.start,payload:{options:e}})},t.prototype.fix=function(e){this.logger.logAdapterMethod("fix",e),this.workflow.call({process:ue.fix,status:ce.start,payload:{options:e}})},t.prototype.relaxUnchained=function(e,t){var i=this,n=function(){return"function"==typeof e&&t===i.reloadId&&e()};return this.isLoading||n(),new Promise((function(e){i.isLoading?i.isLoading$.once((function(){n(),e(!1)})):e(!0)})).then((function(e){var n=t===i.reloadId;return i.logger.log((function(){return n?void 0:"relax promise cancelled due to "+t+" != "+i.reloadId})),{immediate:e,success:n,details:n?null:"Interrupted by reload or reset"}}))},t.prototype.relax=function(e){var t=this,i=this.reloadId;return this.logger.logAdapterMethod("relax",e," of "+i),this.init?this.relaxRun=this.relaxRun?this.relaxRun.then((function(){return t.relaxUnchained(e,i)})):this.relaxUnchained(e,i).then((function(e){return t.relaxRun=null,e})):Promise.resolve(m)},t.prototype.showLog=function(){this.logger.logAdapterMethod("showLog"),this.logger.logForce()},t}(),ei="Invalid datasource:",ti=0,ii=function(){function e(e){var t=e.datasource,i=e.consumer,n=e.element,r=e.workflow,o=e.scroller,s=W(t,Z).params.get;if(!s.isValid)throw new Error("Invalid datasource: "+s.errors[0]);var a=o?o.state.packageInfo:{consumer:i,core:S};n=o?o.viewport.element:n,r=o?o.workflow:r,this.workflow=r,this.settings=new it(t.settings,t.devSettings,++ti),this.logger=new Vt(this,a,t.adapter),this.routines=new Pt(this.settings),this.state=new Yt(a,this.settings,o?o.state:void 0),this.buffer=new Ct(this.settings,r.onDataChanged,this.logger),this.viewport=new $t(n,this.settings,this.routines,this.state,this.logger),this.logger.object("vscroll settings object",this.settings,!0),this.initDatasource(t,o)}return e.prototype.initDatasource=function(e,t){var i=this;if(t)return this.datasource=e,void(this.adapter=t.adapter);var n=e instanceof N,r=!n&&!this.settings.adapter;if(n)this.datasource=e;else{var o=E((function(){return{mock:r}}));this.datasource=new o(e),this.settings.adapter&&(e.adapter=this.datasource.adapter)}var s=r?null:this.datasource.adapter;this.adapter=new Kt(s,(function(){return i.workflow}),this.logger)},e.prototype.init=function(e){this.viewport.reset(this.buffer.startIndex),this.logger.stat("initialization"),this.adapter.initialize(this.buffer,this.state,this.logger,e)},e.prototype.dispose=function(e){e&&this.adapter.dispose(),this.buffer.dispose(),this.state.dispose()},e.prototype.finalize=function(){},e}(),ni=function(){function e(e){var t=this,i=e.element,n=e.datasource,r=e.consumer,o=e.run;this.isInitialized=!1,this.initTimer=null,this.adapterRun$=new u,this.cyclesDone=0,this.interruptionCount=0,this.errors=[],this.disposeScrollEventHandler=function(){return null},this.propagateChanges=o,this.stateMachineMethods={run:this.runProcess(),interrupt:this.interrupt.bind(this),done:this.done.bind(this),onError:this.onError.bind(this)},this.scroller=new ii({element:i,datasource:n,consumer:r,workflow:this.getUpdater()}),this.scroller.settings.initializeDelay?this.initTimer=setTimeout((function(){t.initTimer=null,t.init()}),this.scroller.settings.initializeDelay):this.init()}return e.prototype.init=function(){var e=this;this.scroller.init(this.adapterRun$),this.isInitialized=!0,this.callWorkflow({process:le.init,status:ce.start});var t=this.scroller.viewport.scrollEventReceiver,i=function(t){return e.callWorkflow({process:le.scroll,status:ce.start,payload:{event:t}})};t.addEventListener("scroll",i),this.disposeScrollEventHandler=function(){return t.removeEventListener("scroll",i)}},e.prototype.changeItems=function(e){this.propagateChanges(e)},e.prototype.callWorkflow=function(e){if(this.isInitialized){var t=e.process,i=e.status;t&&t.startsWith("adapter")&&i!==ce.next&&this.adapterRun$.set(e),this.process(e)}},e.prototype.getUpdater=function(){return{call:this.callWorkflow.bind(this),onDataChanged:this.changeItems.bind(this)}},e.prototype.process=function(e){var t=e.status,i=e.process,r=e.payload;this.scroller.settings.logProcessRun&&this.scroller.logger.log((function(){return s(s(s(["%cfire%c"],["color: #cc7777;","color: #000000;"]),[i,'"'+t+'"']),o(void 0!==r?[r]:[]))})),this.scroller.logger.logProcess(e),i===le.end&&this.scroller.finalize(),function(e){var t=e.input,i=t.process,r=t.status,o=t.payload,s=void 0===o?{}:o,a=e.methods,l=a.run,u=a.interrupt,c=a.done,f=a.onError;if(r===ce.error)return f(i,s),void(i.startsWith("adapter")||l(Mt)(s));var d=s.options;switch(i){case le.init:r===ce.start&&l(st)(i),r===ce.next&&l(yt)();break;case le.scroll:r===ce.start&&l(at)(s),r===ce.next&&l(st)(i);break;case ue.reset:case ue.reload:r===ce.start&&(i===ue.reset?l(lt)(d):l(ut)(d)),r===ce.next&&(u(n({process:i},s)),s.finalize?l(Mt)():l(st)(i));break;case ue.append:case ue.prepend:r===ce.start&&l(ft)({process:i,options:d}),r===ce.next&&l(st)(i);break;case ue.check:r===ce.start&&l(dt)(),r===ce.next&&l(st)(i);break;case ue.remove:r===ce.start&&l(pt)(d),r===ce.next&&l(st)(i);break;case ue.clip:r===ce.start&&l(ht)(d),r===ce.next&&l(st)(i);break;case ue.insert:r===ce.start&&l(mt)(d),r===ce.next&&l(st)(i);break;case ue.replace:r===ce.start&&l(vt)(d),r===ce.next&&l(st)(i);break;case ue.update:r===ce.start&&l(gt)(d),r===ce.next&&l(st)(i);break;case ue.fix:r===ce.start&&l(bt)(d),r===ce.next&&l(st)(i);break;case le.start:switch(s.process){case ue.append:case ue.check:case ue.insert:l(zt)();break;case ue.remove:l(kt)();break;case ue.replace:case ue.update:s.doRender?l(zt)():l(kt)();break;default:l(It)()}break;case le.preFetch:if(r===ce.next)switch(s.process){case ue.clip:l(Nt)();break;default:l(wt)()}r===ce.done&&l(Mt)();break;case le.fetch:l(St)();break;case le.postFetch:r===ce.next&&l(zt)(),r===ce.done&&l(Mt)();break;case le.render:if(r===ce.next)switch(s.process){case ue.append:case ue.check:case ue.insert:case ue.replace:case ue.update:l(kt)();break;default:l(Nt)()}r===ce.done&&l(Mt)();break;case le.preClip:s.doClip?l(Et)():l(kt)();break;case le.clip:l(kt)();break;case le.adjust:l(Mt)();break;case le.end:if(r===ce.next)switch(s.process){case ue.reset:case ue.reload:c(),l(st)(s.process);break;default:l(yt)()}r===ce.done&&c()}}({input:e,methods:this.stateMachineMethods})},e.prototype.runProcess=function(){var e=this;return function(t){var i=t.run,n=t.process,r=t.name;return function(){for(var t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];e.scroller.settings.logProcessRun&&e.scroller.logger.log((function(){return s(s(s(["%crun%c"],["color: #333399;","color: #000000;"]),[n||r]),o(t))})),i.apply(void 0,s([e.scroller],o(t)))}}},e.prototype.onError=function(e,t){var i=t&&String(t.error)||"",n=this.scroller.state,r=n.time,o=n.cycle;this.errors.push({process:e,message:i,time:r,loop:o.loopIdNext}),this.scroller.logger.logError(i)},e.prototype.interrupt=function(e){var t=this,i=e.process,n=e.finalize,r=e.datasource;if(n){var o=this.scroller,s=o.workflow,a=o.logger;s.call=function(e){return a.log("[skip wf call]")},s.call.interrupted=!0,this.scroller.workflow=this.getUpdater(),this.interruptionCount++,a.log((function(){return"workflow had been interrupted by the "+i+" process ("+t.interruptionCount+")"}))}r&&this.scroller.adapter.relax((function(){t.scroller.logger.log("new Scroller instantiation");var e=new ii({datasource:r,scroller:t.scroller});t.scroller.dispose(),t.scroller=e,t.scroller.init()}))},e.prototype.done=function(){var e=this.scroller,t=e.state,i=e.logger;this.cyclesDone++,i.logCycle(!1),t.cycle.done(this.cyclesDone+1),this.finalize()},e.prototype.dispose=function(){var e=this;this.initTimer&&clearTimeout(this.initTimer),this.disposeScrollEventHandler(),this.adapterRun$.dispose(),this.scroller.dispose(!0),Object.getOwnPropertyNames(this).forEach((function(t){delete e[t]}))},e.prototype.finalize=function(){},e}();e.EMPTY_ITEM=y,e.INVALID_DATASOURCE_PREFIX=ei,e.Workflow=ni,e.getDefaultAdapterProps=I,e.makeDatasource=E,e.packageInfo=S,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=vscroll.umd.min.js.map
